<!DOCTYPE html>
<html lang="de">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zugangsvoraussetzungen</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
      :root {
        --softrot: rgb(228, 100, 80);
        --drk-gruen: rgb(0, 150, 80);
        --dunkelblau: rgb(0, 45, 85);
        --hellblau: rgb(100, 160, 220);
        --mittelgrau: rgb(180, 180, 180);
        --hellgruene-progress: #28a745;
        /* Kräftigeres Hellgrün für 80% */
      }

      .page-title {
        color: var(--softrot);
        margin-bottom: 1rem;
        font-size: 1.4rem;
      }

      .zugang-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
      }

      @media (max-width: 768px) {
        .zugang-grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: #fff;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 18px rgba(0, 0, 0, 0.28);
        border: 1px solid #eef2f7;
      }

      .card h3 {
        color: var(--hellblau);
        margin-top: 0;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.05rem;
      }

      .checklist {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .checklist li {
        margin: 0.6rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
      }

      .checklist input[type="checkbox"] {
        appearance: auto;
        -webkit-appearance: auto;
        width: 1.2rem;
        height: 1.2rem;
        cursor: pointer;
      }

      .progress {
        height: 22px;
        background-color: #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1rem;
      }

      .progress-bar {
        height: 100%;
        text-align: center;
        font-size: 0.85rem;
        font-weight: bold;
        transition: width 0.3s ease, background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
      }

      .select-user {
        margin-bottom: 1rem;
      }

      .selected-user,
      #confirmText {
        font-weight: bold;
        color: var(--dunkelblau);
        font-size: 1.05rem;
        margin-top: 1rem;
      }

      .btn-confirm {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin: 0.5rem 0.5rem 0 0;
        padding: 0.6rem 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        color: #fff;
        font-weight: bold;
        width: 260px;
      }

      .btn-green {
        background: var(--drk-gruen);
      }

      .btn-red {
        background: var(--softrot);
      }

      .btn-blue {
        background: var(--dunkelblau);
      }

      select {
        width: 100%;
        padding: 0.6rem;
        border-radius: 8px;
        border: 1px solid var(--dunkelblau);
        background: #fff;
        font-size: 1rem;
        color: var(--dunkelblau);
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml;utf8,<svg fill='%23002D55' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
      }

      select:focus {
        outline: none;
        border-color: var(--dunkelblau);
        box-shadow: none;
      }

      @media (min-width: 769px) {
        .select-user select {
          max-width: 300px;
        }
      }

      #toast {
        visibility: hidden;
        min-width: 250px;
        background-color: var(--dunkelblau);
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 16px;
        position: fixed;
        z-index: 2000;
        left: 50%;
        bottom: 30px;
        font-size: 1rem;
        opacity: 0;
        transform: translateX(-50%);
        transition: opacity 0.5s, bottom 0.5s;
      }

      #toast.show {
        visibility: visible;
        opacity: 1;
        bottom: 50px;
      }

      /* Modal */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        z-index: 1999;
      }

      .modal {
        position: fixed;
        inset: 0;
        display: none;
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }

      .modal .modal-card {
        background: #fff;
        color: #111;
        border-radius: 14px;
        width: min(520px, 96vw);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
        padding: 1rem;
        border: 1px solid #e5e7eb;
      }

      .modal h4 {
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 0;
        margin-bottom: 0.6rem;
        color: var(--dunkelblau);
      }

      .modal p {
        margin: 0.2rem 0 1rem;
        color: #374151;
        line-height: 1.4;
      }

      .modal .modal-actions {
        display: flex;
        gap: 0.8rem;
        justify-content: flex-end;
        margin-top: 1rem;
      }

      .modal .btn {
        padding: 0.6rem 1rem;
        border: none;
        border-radius: 10px;
        font-size: 0.95rem;
        cursor: pointer;
      }

      .modal .btn-secondary {
        background: #eef2f7;
      }

      .modal .btn-primary {
        background: var(--dunkelblau);
        color: #fff;
      }

      .modal .btn-danger {
        background: var(--softrot);
        color: #fff;
      }

      /* Statusfarben */
      .status-ok {
        font-weight: bold;
        color: var(--drk-gruen);
      }

      .status-bad {
        font-weight: bold;
        color: var(--softrot);
      }

      .status-pending {
        font-weight: bold;
        color: var(--dunkelblau);
      }

      .muted {
        color: #6b7280;
        font-size: 0.95rem;
      }

      .text-green {
        color: var(--drk-gruen);
        font-weight: bold;
      }

      .text-red {
        color: var(--softrot);
        font-weight: bold;
      }

      .status-message {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .status-message i {
        flex-shrink: 0;
        font-size: 1.2rem;
        line-height: 1.2;
      }

      #statusList li {
        gap: 0.75rem;
      }

      h3::first-letter {
        font-size: 1.5rem;
        font-weight: bold;
        margin-right: 0.3rem;
      }

      @media (max-width: 768px) {
        .status-message {
          flex-direction: row;
          gap: 1rem;
          align-items: center;
        }

        .status-message .status-ok,
        .status-message .status-bad,
        .status-message .status-pending {
          display: inline-flex;
        }
      }

   /* Excel-Export Container */
.export-container {
  background-color: #fff;
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 4px 18px rgba(0, 0, 0, 0.28); /* Schatten anpassen */
  width: 100%;
  max-width: 700px; /* Gleiche Breite wie Grundvoraussetzungen */
  margin-top: 1.5rem; /* Gleicher Abstand wie bei anderen Boxen */
  display: flex;
  flex-direction: column; /* Buttons unter der Überschrift */
  gap: 1.5rem; /* Abstand zwischen Überschrift und Buttons */
}

/* Überschrift des Excel-Export Containers */
.export-container h3 {
  color: var(--hellblau); /* Gleiche Farbe wie bei anderen Überschriften */
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 1.05rem; /* Gleiche Schriftgröße wie bei anderen Überschriften */
  margin-top: 0; /* Keine zusätzliche Margen */
  margin-bottom: 0; /* Kein zusätzlicher Abstand nach der Überschrift */
}

/* Button-Wrapper, der die Buttons nebeneinander anordnet */
.export-container .button-wrapper {
  display: flex; /* Flexbox sorgt für nebeneinander anordnen */
  gap: 1rem;  /* Abstand zwischen den Buttons */
  justify-content: flex-start; /* Links ausgerichtet */
  flex-wrap: nowrap; /* Kein Umbruch */
  width: 100%; /* Verwendet die gesamte Breite des Containers */
  overflow: hidden; /* Verhindert, dass die Buttons aus dem Container herausragen */
}

/* Anpassung der Button-Stile */
.export-container button {
  width: 250px;  /* Feste Breite der Buttons */
  height: 45px;  /* Gleiche Höhe wie die anderen Buttons */
  font-weight: normal;  /* Normalgewicht für den Text */
  font-size: 0.9rem; /* Textgröße auf 0.9rem gesetzt */
  display: inline-flex;
  align-items: center;
  justify-content: flex-start;  /* Icons linksbündig ausrichten */
  gap: 0.6rem; /* Abstand zwischen dem Icon und dem Text */
  padding-left: 0.75rem;  /* Symmetrischer Abstand des Icons zur Kante */
  padding-right: 1rem; /* Gleichmäßiger Abstand auf der rechten Seite */
  margin: 0;  /* Kein zusätzlicher Abstand zwischen den Buttons */
  box-sizing: border-box; /* Stellt sicher, dass die Buttons den gesamten Raum korrekt nutzen */
}

/* Icon-Größe im Button anpassen */
.export-container button i {
  font-size: 0.9rem; /* Icon-Größe auf 0.9rem reduziert */
}
    </style>
  </head>
  <body>
       <h2 class="page-title">Zugangsvoraussetzungen</h2>

    <!-- Nutzer-Auswahl (Admin/GL) -->
    <div
      class="card select-user"
      id="selectUserCard"
      style="margin-bottom: 1.5rem; display: none"
    >
      <h3><i class="bi bi-people"></i> Nutzer auswählen</h3>
      <div>
        <select id="userSelect">
          <option value="">-- bitte wählen --</option>
        </select>
        <div id="selectedUser" class="selected-user"></div>
      </div>
    </div>
    <div class="zugang-grid">
      <!-- Grundvoraussetzungen -->
      <div class="card">
        <h3><i class="bi bi-bricks"></i> Grundvoraussetzungen</h3>
        <div class="progress">
          <div id="grund-progress" class="progress-bar" style="width: 0%"></div>
        </div>
        <ul class="checklist" id="grund-list">
          <li>
            <input type="checkbox" disabled />
            Fachdienstausbildung Sanitätsdienst
          </li>
          <li>
            <input type="checkbox" disabled />
            Erstgespräch mit Vorstellung des Ausbildungsverlaufs und der IuK Lernwelt
          </li>
          <li>
            <input type="checkbox" disabled /> Vollendung 18. Lebensjahr
          </li>
          <li>
            <input type="checkbox" disabled />
            Hospitation 1 Dienst in der Integrierten Leitstelle Bodensee-Oberschwaben
          </li>
          <li>
            <input type="checkbox" disabled />
            min. 2-jähriges aktives Mitwirken im Sanitäts- oder Rettungsdienst
          </li>
        </ul>
      </div>

      <!-- Optionale Voraussetzungen -->
      <div class="card">
        <h3><i class="bi bi-clipboard-pulse"></i> Optionale Voraussetzungen</h3>
        <div class="progress">
          <div id="verlauf-progress" class="progress-bar" style="width: 0%"></div>
        </div>
        <ul class="checklist" id="verlauf-list">
          <li><input type="checkbox" disabled /> C1 (Helfer-)Führerschein</li>
          <li><input type="checkbox" disabled /> Gruppenführer Sanitätsdienst</li>
        </ul>
      </div>
    </div>

    <!-- Bestätigung -->
    <div class="card" style="margin-top: 1.5rem">
      <h3><i class="bi bi-card-checklist"></i> Bestätigung durch den Gruppenleiter</h3>

      <!-- Admin/GL Variante -->
      <div id="confirmAdmin" style="display: none">
        <p id="confirmText"></p>

        <div class="checklist">
          <label
            ><input type="checkbox" id="chkGrund" disabled />
            Alle Grundvoraussetzungen erfüllt</label
          >
        </div>

        <div id="grundActions" style="display: none; margin-top: 0.5rem">
          <button class="btn-confirm btn-green" data-action="freigeben">
            <i class="bi bi-check-circle"></i> Mitglied für den aktiven Dienst freigeben
          </button>
        </div>

        <div class="checklist" style="margin-top: 1rem">
          <label
            ><input type="checkbox" id="chkOptional" disabled />
            Optionale Voraussetzungen erfüllt</label
          >
        </div>

        <div id="optionalActions" style="display: none; margin-top: 0.5rem">
          <button class="btn-confirm btn-blue" data-action="mail">
            <i class="bi bi-envelope"></i> Bestätigung per Mail senden
          </button>
        </div>

        <hr style="margin: 1rem 0" />

        <div class="checklist" style="margin-top: 1rem">
          <label
            ><input type="checkbox" id="chkReject" />
            Soll für den aktiven Dienst <strong>nicht</strong> freigegeben werden</label
          >
        </div>

        <div id="rejectActions" style="margin-top: 0.5rem; display: none">
          <button class="btn-confirm btn-red" data-action="ablehnen">
            <i class="bi bi-x-circle"></i> Mitglied für den aktiven Dienst ablehnen
          </button>
        </div>
      </div>

      <!-- Helfer/Anwärter Variante -->
      <div id="confirmUser" style="display: none">
        <p><strong>Statusübersicht</strong></p>
        <ul class="checklist" id="statusList">
          <li><span id="statusGrund"></span> Grundvoraussetzungen</li>
          <li><span id="statusOptional"></span> Optionale Voraussetzungen</li>
          <li><span id="statusReject"></span></li>
        </ul>
        <p class="muted">
          Hinweis: Die Bestätigung kann nur von Gruppenleiter:innen oder Administrator:innen
          vorgenommen werden.
        </p>
      </div>
    </div>
   
<!-- Excel-Export-Container -->
<div id="exportContainer" class="export-container">
  <h3><i class="bi bi-file-earmark-excel"></i> Excel-Export</h3>
  
  <!-- Button für den eigenen Nutzer -->
  <button id="btnExportCurrentUser" class="btn-confirm btn-blue">
    <i class="bi bi-download"></i> <strong>Eigenen Nutzer</strong> exportieren
  </button>
  
  <!-- Button für alle Nutzer -->
  <button id="btnExportAllUsers" class="btn-confirm btn-blue">
    <i class="bi bi-download"></i> <strong>Alle Nutzer</strong> exportieren
  </button>
</div>

    <div id="toast"></div>

    <!-- Modal -->
    <div id="modalBackdrop" class="modal-backdrop"></div>
    <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-card">
        <h4 id="modalTitle">Bestätigen</h4>
        <p id="modalMessage">Bist du sicher?</p>
        <div class="modal-actions">
          <button id="modalCancel" class="btn btn-secondary">
            <i class="bi bi-x-lg"></i> Abbrechen
          </button>
          <button id="modalOk" class="btn btn-primary">
            <i class="bi bi-check2"></i> OK
          </button>
        </div>
      </div>
    </div>
    <script type="module">
      /***********************
       * Firebase & Firestore
       ***********************/
      import {
        auth,
        db,
        observeAuthState,
        getUserRoles,
      } from "./js/firebase.js";
      import {
        doc,
        getDoc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      /***********************
       * API (Cloud Functions) – wie Benutzerverwaltung
       ***********************/
      const API_BASE = "https://europe-west3-iuk-app.cloudfunctions.net";
      async function apiFetch(endpoint, options = {}) {
        const user = auth.currentUser;
        if (!user) throw new Error("Nicht eingeloggt");
        const token = await user.getIdToken();
        const headers = {
          ...(options.headers || {}),
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        };
        return fetch(API_BASE + endpoint, { ...options, headers });
      }

      /***********************
       * DOM-Referenzen
       ***********************/
      const userSelect = document.getElementById("userSelect");
      const selectUserCard = document.getElementById("selectUserCard");
      const selectedUser = document.getElementById("selectedUser");
      const confirmUserSection = document.getElementById("confirmUser");
      const confirmAdminSection = document.getElementById("confirmAdmin");
      const confirmText = document.getElementById("confirmText");
      const grundBoxes = document.querySelectorAll("#grund-list input");
      const verlaufBoxes = document.querySelectorAll("#verlauf-list input");
      const grundProgress = document.getElementById("grund-progress");
      const verlaufProgress = document.getElementById("verlauf-progress");
      const chkGrund = document.getElementById("chkGrund");
      const chkOptional = document.getElementById("chkOptional");
      const chkReject = document.getElementById("chkReject");

      // Toast
      const toast = document.getElementById("toast");
      function showToast(msg) {
        toast.textContent = msg;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2600);
      }

      // Modal wie in Benutzerverwaltung
      const modal = document.getElementById("modal");
      const backdrop = document.getElementById("modalBackdrop");
      const modalTitle = document.getElementById("modalTitle");
      const modalMessage = document.getElementById("modalMessage");
      const modalOk = document.getElementById("modalOk");
      const modalCancel = document.getElementById("modalCancel");

      function openModal({
        title = "Bestätigen",
        message = "Bist du sicher?",
        okText = "OK",
        cancelText = "Abbrechen",
      } = {}) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalOk.innerHTML = `<i class="bi bi-check2"></i> ${okText}`;
        modalCancel.innerHTML = `<i class="bi bi-x-lg"></i> ${cancelText}`;
        modal.style.display = "flex";
        backdrop.style.display = "block";
        return new Promise((resolve) => {
          const close = (val) => {
            modal.style.display = "none";
            backdrop.style.display = "none";
            resolve(val);
          };
          const onEsc = (e) => {
            if (e.key === "Escape") {
              document.removeEventListener("keydown", onEsc);
              close(false);
            }
          };
          document.addEventListener("keydown", onEsc);
          modalOk.onclick = () => {
            document.removeEventListener("keydown", onEsc);
            close(true);
          };
          modalCancel.onclick = () => {
            document.removeEventListener("keydown", onEsc);
            close(false);
          };
          backdrop.onclick = () => {
            document.removeEventListener("keydown", onEsc);
            close(false);
          };
        });
      }

      // Prozentfarben & Anzeige
      function setProgressColor(bar, percent) {
        if (percent === 0) {
          bar.style.backgroundColor = "#e9ecef";
          bar.textContent = "";
        } else {
          if (percent <= 20) bar.style.backgroundColor = "red";
          else if (percent <= 40) bar.style.backgroundColor = "orange";
          else if (percent <= 60) bar.style.backgroundColor = "gold";
          else if (percent <= 80)
            bar.style.backgroundColor = "var(--hellgruene-progress)";
          else bar.style.backgroundColor = "var(--drk-gruen)";
          bar.textContent = percent + "%";
        }
      }

      function updateProgress(boxes, bar, gate) {
        const total = boxes.length;
        const checked = Array.from(boxes).filter((b) => b.checked).length;
        const percent = Math.round((checked / total) * 100);
        bar.style.width = percent + "%";
        setProgressColor(bar, percent);
        if (gate) {
          gate.disabled = percent !== 100;
          if (percent !== 100) gate.checked = false;
        }
      }

      /***********************
       * Firestore: Fortschritt laden/speichern + freigabeStatus
       ***********************/
      async function loadProgress(userId) {
        const ref = doc(db, "users", userId);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data();
          // Grund
          if (Array.isArray(data.grund)) {
            grundBoxes.forEach((box, i) => {
              box.checked = !!data.grund[i];
            });
          } else {
            grundBoxes.forEach((box) => (box.checked = false));
          }
          updateProgress(grundBoxes, grundProgress, chkGrund);
          // Optional
          if (Array.isArray(data.optional)) {
            verlaufBoxes.forEach((box, i) => {
              box.checked = !!data.optional[i];
            });
          } else {
            verlaufBoxes.forEach((box) => (box.checked = false));
          }
          updateProgress(verlaufBoxes, verlaufProgress, chkOptional);
          // Freigabe/Ablehnung Status anzeigen
          updateStatusDisplay(data.freigabeStatus);
        } else {
          grundBoxes.forEach((box) => (box.checked = false));
          verlaufBoxes.forEach((box) => (box.checked = false));
          updateProgress(grundBoxes, grundProgress, chkGrund);
          updateProgress(verlaufBoxes, verlaufProgress, chkOptional);
          updateStatusDisplay(null);
        }
      }

      async function saveProgress(userId, type, values) {
        const ref = doc(db, "users", userId);
        await updateDoc(ref, { [type]: values });
      }

      /***********************
       * Nutzerliste (Cloud Function)
       ***********************/
      async function loadUsersViaFunction() {
        const res = await apiFetch("/listUsers", { method: "GET" });
        if (!res.ok) {
          const msg = `${res.status} ${res.statusText}`;
          throw new Error(msg);
        }
        const data = await res.json();
        userSelect.innerHTML = `<option value="">-- bitte wählen --</option>`;
        (data.users || []).forEach((u) => {
          const label = u.displayName || u.email || u.uid;
          userSelect.innerHTML += `<option value="${u.uid}">${label}</option>`;
        });
      }

      /***********************
       * Statusanzeige für Helfer/Anwärter
       ***********************/
      function updateStatusDisplay(status) {
        const grundErfüllt = Array.from(grundBoxes).every((b) => b.checked);
        document.getElementById("statusGrund").innerHTML = grundErfüllt
          ? `<div class="status-message"><i class="bi bi-check-circle status-ok"></i></div>`
          : `<div class="status-message"><i class="bi bi-x-circle status-bad"></i></div>`;

        const optionalErfüllt = Array.from(verlaufBoxes).every((b) => b.checked);
        document.getElementById("statusOptional").innerHTML = optionalErfüllt
          ? `<div class="status-message"><i class="bi bi-check-circle status-ok"></i></div>`
          : `<div class="status-message"><i class="bi bi-x-circle status-bad"></i></div>`;

        let statusText = "";
        if (status === "freigeben") {
          statusText = `<div class="status-message"><i class="bi bi-check-circle status-ok"></i><span>Du wurdest für den aktiven Dienst <span class="text-green">freigegeben.</span> Herzlichen Glückwunsch!</span></div>`;
        } else if (status === "ablehnen") {
          statusText = `<div class="status-message"><i class="bi bi-x-circle status-bad"></i><span>Du wurdest für den aktiven Dienst <span class="text-red">abgelehnt.</span> Bei Rückfragen wende dich bitte an deinen Gruppenleiter!</span></div>`;
        } else {
          statusText = `<div class="status-message"><i class="bi bi-hourglass status-pending"></i><span>Freigabestatus: noch offen</span></div>`;
        }
        document.getElementById("statusReject").innerHTML = statusText;
      }

      /***********************
       * Verhalten nach Rolle
       ***********************/
      observeAuthState(async (user) => {
        if (!user) return;
        const roles = await getUserRoles(user.uid);
        if (roles.includes("admin") || roles.includes("gruppenleiter")) {
          selectUserCard.style.display = "block";
          confirmAdminSection.style.display = "block";
          confirmUserSection.style.display = "none";
          grundBoxes.forEach((cb) => {
            cb.disabled = true;
            cb.checked = false;
          });
          verlaufBoxes.forEach((cb) => {
            cb.disabled = true;
            cb.checked = false;
          });
          chkGrund.disabled = true;
          chkGrund.checked = false;
          chkOptional.disabled = true;
          chkOptional.checked = false;
          chkReject.checked = false;
          document.getElementById("grundActions").style.display = "none";
          document.getElementById("optionalActions").style.display = "none";
          document.getElementById("rejectActions").style.display = "none";
          try {
            await loadUsersViaFunction();
          } catch (e) {
            showToast("Fehler beim Laden der Nutzer");
            console.error(e);
          }
        } else {
          selectUserCard.style.display = "none";
          confirmUserSection.style.display = "block";
          confirmAdminSection.style.display = "none";
          confirmText.textContent = "Dein eigener Status";
          grundBoxes.forEach((cb) => (cb.disabled = true));
          verlaufBoxes.forEach((cb) => (cb.disabled = true));
          chkGrund.disabled = true;
          chkOptional.disabled = true;
          chkReject.disabled = true;
          await loadProgress(user.uid);
        }
      });

      /***********************
       * Fortschritt speichern
       ***********************/
      document
        .getElementById("grund-list")
        .addEventListener("change", () => {
          updateProgress(grundBoxes, grundProgress, chkGrund);
          if (userSelect.value) {
            const values = Array.from(grundBoxes).map((b) => b.checked);
            saveProgress(userSelect.value, "grund", values).catch((err) =>
              console.error(err)
            );
          }
        });

      document
        .getElementById("verlauf-list")
        .addEventListener("change", () => {
          updateProgress(verlaufBoxes, verlaufProgress, chkOptional);
          if (userSelect.value) {
            const values = Array.from(verlaufBoxes).map((b) => b.checked);
            saveProgress(userSelect.value, "optional", values).catch((err) =>
              console.error(err)
            );
          }
        });

      /***********************
       * Buttons sichtbar machen
       ***********************/
      chkGrund.addEventListener("change", () => {
        document.getElementById("grundActions").style.display = chkGrund.checked
          ? "block"
          : "none";
      });
      chkOptional.addEventListener("change", () => {
        document.getElementById("optionalActions").style.display =
          chkOptional.checked ? "block" : "none";
      });
      chkReject.addEventListener("change", (e) => {
        document.getElementById("rejectActions").style.display = e.target.checked
          ? "block"
          : "none";
      });

      /***********************
       * Aktionen mit Modal
       ***********************/
      document.body.addEventListener("click", async (e) => {
        const btn = e.target.closest("[data-action]");
        if (!btn) return;
        const action = btn.dataset.action;
        let title,
          message,
          okText = "Bestätigen";
        if (action === "freigeben") {
          title = "Mitglied freigeben";
          message =
            "Soll das Mitglied wirklich für den aktiven Dienst freigegeben werden?";
        } else if (action === "mail") {
          title = "Bestätigung per Mail senden";
          message = "Soll eine Bestätigung per Mail gesendet werden?";
        } else if (action === "ablehnen") {
          title = "Mitglied ablehnen";
          message =
            "Soll das Mitglied wirklich für den aktiven Dienst abgelehnt werden?";
          okText = "Ablehnen";
        }
        const ok = await openModal({ title, message, okText });
        if (ok) {
          if (action === "freigeben") showToast("Mitglied freigegeben");
          if (action === "mail") showToast("Mail gesendet");
          if (action === "ablehnen") showToast("Mitglied abgelehnt");
          if (
            (action === "freigeben" || action === "ablehnen") &&
            userSelect.value
          ) {
            try {
              await updateDoc(doc(db, "users", userSelect.value), {
                freigabeStatus: action,
              });
              await loadProgress(userSelect.value);
            } catch (err) {
              console.error("Fehler beim Speichern:", err);
              showToast("Speichern fehlgeschlagen");
            }
          }
        }
      });

      /***********************
       * Nutzerwechsel
       ***********************/
      userSelect.addEventListener("change", async () => {
        if (userSelect.value) {
          const name = userSelect.options[userSelect.selectedIndex].text;
          selectedUser.textContent = "Ausgewählt: " + name;
          confirmText.textContent = "Bestätigung für: " + name;
          confirmAdminSection.style.display = "block";
          confirmUserSection.style.display = "none";
          grundBoxes.forEach((cb) => (cb.disabled = false));
          verlaufBoxes.forEach((cb) => (cb.disabled = false));
          chkGrund.disabled = true;
          chkGrund.checked = false;
          chkOptional.disabled = true;
          chkOptional.checked = false;
          chkReject.checked = false;
          document.getElementById("grundActions").style.display = "none";
          document.getElementById("optionalActions").style.display = "none";
          document.getElementById("rejectActions").style.display = "none";
          await loadProgress(userSelect.value);
        } else {
          selectedUser.textContent = "";
          confirmAdminSection.style.display = "block";
          confirmUserSection.style.display = "none";
          grundBoxes.forEach((cb) => {
            cb.disabled = true;
            cb.checked = false;
          });
          verlaufBoxes.forEach((cb) => {
            cb.disabled = true;
            cb.checked = false;
          });
          updateProgress(grundBoxes, grundProgress, chkGrund);
          updateProgress(verlaufBoxes, verlaufProgress, chkOptional);
        }
      });
  /***********************
 * Excel-Export
 ***********************/
// Funktion für den Export des aktuellen Nutzers
document.getElementById("btnExportCurrentUser").addEventListener("click", async () => {
  try {
    const user = auth.currentUser;
    if (!user) {
      showToast("Kein Nutzer eingeloggt!");
      return;
    }

    const userData = await getDoc(doc(db, "users", user.uid));
    const rows = [
      ["Name / Email", "Grundvoraussetzungen (%)", "Optionale Voraussetzungen (%)", "Freigabe-Status"]
    ];

    if (userData.exists()) {
      const data = userData.data();
      const grundPct = Math.round((data.grund.filter(Boolean).length / data.grund.length) * 100);
      const optPct = Math.round((data.optional.filter(Boolean).length / data.optional.length) * 100);
      const status = data.freigabeStatus || "offen";

      rows.push([user.displayName || user.email || user.uid, grundPct + "%", optPct + "%", status]);

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Zugangsvoraussetzungen");
      XLSX.writeFile(wb, "aktuell_nutzer_zugang.xlsx");

      showToast("Excel-Datei für den aktuellen Nutzer erfolgreich erstellt!");
    } else {
      showToast("Fehler beim Abrufen der Nutzerdaten.");
    }
  } catch (err) {
    console.error(err);
    showToast("Fehler beim Export");
  }
});

// Funktion für den Export aller Nutzer
document.getElementById("btnExportAllUsers").addEventListener("click", async () => {
  try {
    const res = await apiFetch("/listUsers", { method: "GET" });
    if (!res.ok) throw new Error("Fehler beim Abrufen der Benutzerdaten");
    const data = await res.json();

    const rows = [["Name / Email", "Grundvoraussetzungen (%)", "Optionale Voraussetzungen (%)", "Freigabe-Status"]];

    for (const u of data.users || []) {
      const ref = doc(db, "users", u.uid);
      const snap = await getDoc(ref);
      let grundPct = 0, optPct = 0, status = "";
      if (snap.exists()) {
        const d = snap.data();
        if (Array.isArray(d.grund)) grundPct = Math.round((d.grund.filter(Boolean).length / d.grund.length) * 100);
        if (Array.isArray(d.optional)) optPct = Math.round((d.optional.filter(Boolean).length / d.optional.length) * 100);
        status = d.freigabeStatus || "offen";
      }
      rows.push([u.displayName || u.email || u.uid, grundPct + "%", optPct + "%", status]);
    }

    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Zugangsvoraussetzungen");
    XLSX.writeFile(wb, "alle_nutzer_zugang.xlsx");

    showToast("Excel-Datei für alle Nutzer erfolgreich erstellt!");
  } catch (err) {
    console.error(err);
    showToast("Fehler beim Export");
  }
});

/***********************
 * Zeige Buttons je nach Rolle an
 ***********************/
async function checkUserRole() {
  const user = auth.currentUser;
  if (!user) return; // Wenn kein Nutzer eingeloggt, abbrechen

  const roles = await getUserRoles(user.uid);
  
  // Zeige den Button für "Alle Nutzer exportieren" nur, wenn der Nutzer Admin oder Gruppenleiter ist
  const exportAllButton = document.getElementById("btnExportAllUsers");

  if (roles.includes("admin") || roles.includes("gruppenleiter")) {
    exportAllButton.style.display = "inline-flex";  // Zeige den "Alle Nutzer exportieren"-Button
  } else {
    exportAllButton.style.display = "none";  // Verstecke den Button für "Alle Nutzer exportieren"
  }
}

// Rufe die Funktion auf, wenn die Seite geladen wird
checkUserRole();
    </script>
  </body>
</html>
