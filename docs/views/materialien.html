<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Materialien</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    :root{
      --softrot: rgb(228,100,80);
      --dunkelblau: rgb(0,45,85);
      --hellgrau: rgb(239,238,234);
      --blassblau: rgb(230,240,250);
      --text:#1f2937;
      --hellblau: rgb(100,160,220); 
      --material-bg: #fff; 
      --material-bd: #e5e7eb;
      --material-fg: #374151;
    }

    *{box-sizing:border-box}

    .material-page {
      color: var(--text);
      padding: 1rem;
    }

    .material-page .page-title{
      color: var(--softrot);
      margin: 0 0 1rem;
    }

    .material-page .material-grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    @media (max-width: 980px) {
      .material-page .material-grid{
        grid-template-columns: 1fr;
      }
    }

    .material-page .card {
      background: var(--material-bg);
      padding: 1.25rem;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      margin-bottom: 1.5rem;
      border: 1px solid var(--material-bd);
    }

    .material-page .card h3 {
      color: var(--hellblau); 
      margin: 0 0 1rem;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }

    .material-page .material-list {
      list-style: none;
      padding-left: 0;
      display: none; 
      margin-top: 1rem;
    }

    .material-page .material-list.open {
      display: block; 
    }

    .material-page .material-list li {
      padding: 0.8rem;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .material-page .material-list li:hover {
      background: var(--blassblau);
    }

    .material-page .btn {
      padding: 0.6rem 1.2rem;
      border-radius: 10px;
      background: var(--dunkelblau);
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }

    .material-page .btn-primary {
      background: var(--dunkelblau);
    }

    .material-page .search-box {
      margin-bottom: 1.5rem;
      position: relative;
    }

    .material-page input[type="text"] {
      padding: 8px 40px 8px 10px;
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    #auth-container {
      margin-bottom: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="material-page">
    <h2 class="page-title">Materialien</h2>

    <!-- Anmeldeformular -->
    <div id="auth-container">
      <button id="loginBtn" class="btn btn-primary">Login</button>
      <button id="logoutBtn" class="btn btn-danger" style="display: none;">Logout</button>
    </div>

    <!-- Suchfeld -->
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Suche Materialien...">
    </div>

    <div class="material-grid">
      <!-- Globale Materialien -->
      <div class="card material-global">
        <h3 onclick="toggleList('global')"><i class="bi bi-box"></i> Globale Materialien</h3>
        <ul class="material-list" id="globalMaterialsList">
        </ul>
        <button class="btn btn-primary" id="addGlobalMaterialBtn" style="display: none;">Material hinzufügen</button>
        <button class="btn btn-primary" id="addGlobalFolderBtn" style="display: none;">Ordner hinzufügen</button>
      </div>

      <!-- Persönliche Materialien -->
      <div class="card material-personal">
        <h3 onclick="toggleList('personal')"><i class="bi bi-person-circle"></i> Persönliche Materialien</h3>
        <ul class="material-list" id="personalMaterialsList">
        </ul>
        <button class="btn btn-primary" id="addPersonalMaterialBtn">Material hinzufügen</button>
        <button class="btn btn-primary" id="addPersonalFolderBtn">Ordner hinzufügen</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase-Initialisierung
    import { initializeApp } from "firebase/app";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "firebase/auth";
    import { getFirestore, collection, addDoc, getDocs, query, where } from "firebase/firestore";

    const firebaseConfig = {
      apiKey: "AIzaSyDIuKwYoKQDyzy6qpmY2LGahJofZx6qnuw",
      authDomain: "iuk-app.firebaseapp.com",
      projectId: "iuk-app",
      storageBucket: "iuk-app.appspot.com",
      messagingSenderId: "759014128178",
      appId: "1:759014128178:web:09c3690cd95b402c8ada2b",
      measurementId: "G-ZPD5VPD5TS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // DOM-Elemente
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const addGlobalMaterialBtn = document.getElementById("addGlobalMaterialBtn");
    const addGlobalFolderBtn = document.getElementById("addGlobalFolderBtn");
    const addPersonalMaterialBtn = document.getElementById("addPersonalMaterialBtn");
    const addPersonalFolderBtn = document.getElementById("addPersonalFolderBtn");
    const globalMaterialsList = document.getElementById("globalMaterialsList");
    const personalMaterialsList = document.getElementById("personalMaterialsList");
    const searchInput = document.getElementById("searchInput");

    let user = null;

    // Anmeldung mit Google
    loginBtn.addEventListener("click", () => {
      signInWithPopup(auth, provider).then((result) => {
        user = result.user;
        console.log("Angemeldet als:", user.displayName);
        loginBtn.style.display = "none";
        logoutBtn.style.display = "block";
        loadMaterials();
      }).catch((error) => {
        console.error(error);
      });
    });

    // Logout
    logoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => {
        user = null;
        loginBtn.style.display = "block";
        logoutBtn.style.display = "none";
        globalMaterialsList.innerHTML = '';
        personalMaterialsList.innerHTML = '';
      });
    });

    // Toggle für Materiallisten
    function toggleList(type) {
      const list = document.getElementById(`${type}MaterialsList`);
      list.classList.toggle('open');
    }

    // Materialien laden
    function loadMaterials() {
      loadGlobalMaterials();
      loadPersonalMaterials();
    }

    // Globale Materialien laden
    async function loadGlobalMaterials() {
      const querySnapshot = await getDocs(collection(db, "globalMaterials"));
      globalMaterialsList.innerHTML = '';
      querySnapshot.forEach((doc) => {
        const material = doc.data();
        const li = document.createElement("li");
        li.innerHTML = `<strong>${material.name}</strong><br>${material.description}`;
        globalMaterialsList.appendChild(li);
      });

      // Berechtigungen für Admins und Gruppenleiter
      if (user && (user.email === "admin@example.com" || user.email === "groupleader@example.com")) {
        addGlobalMaterialBtn.style.display = "block";
        addGlobalFolderBtn.style.display = "block";
      }
    }

    // Persönliche Materialien laden
    async function loadPersonalMaterials() {
      if (!user) return;

      const q = query(collection(db, "personalMaterials"), where("userId", "==", user.uid));
      const querySnapshot = await getDocs(q);
      personalMaterialsList.innerHTML = '';
      querySnapshot.forEach((doc) => {
        const material = doc.data();
        const li = document.createElement("li");
        li.innerHTML = `<strong>${material.name}</strong><br>${material.description}`;
        personalMaterialsList.appendChild(li);
      });

      addPersonalMaterialBtn.style.display = "block";
      addPersonalFolderBtn.style.display = "block";
    }

    // Materialien hinzufügen (Globale Materialien)
    addGlobalMaterialBtn.addEventListener("click", () => {
      const material = {
        name: "Beispiel Globales Material",
        description: "Dies ist ein Beispielmaterial."
      };

      addDoc(collection(db, "globalMaterials"), material).then(() => {
        loadGlobalMaterials();
      });
    });

    // Materialien hinzufügen (Persönliche Materialien)
    addPersonalMaterialBtn.addEventListener("click", () => {
      const material = {
        name: "Beispiel Persönliches Material",
        description: "Dies ist ein Beispielmaterial.",
        userId: user.uid
      };

      addDoc(collection(db, "personalMaterials"), material).then(() => {
        loadPersonalMaterials();
      });
    });

    // Suchfeld für Materialien
    searchInput.addEventListener("input", () => {
      const query = searchInput.value.toLowerCase();
      const filteredGlobal = globalMaterials.filter(m => m.name.toLowerCase().includes(query) || m.description.toLowerCase().includes(query));
      const filteredPersonal = personalMaterials.filter(m => m.name.toLowerCase().includes(query) || m.description.toLowerCase().includes(query));

      loadMaterials(filteredGlobal, filteredPersonal);
    });
  </script>
</body>
</html>
