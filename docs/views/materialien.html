<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Materialien</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
 <style>
  :root {
    --softrot: rgb(228,100,80);
    --dunkelblau: rgb(0,45,85);
    --hellgrau: rgb(239,238,234);
    --blassblau: rgb(230,240,250);
    --text: #1f2937;
    --hellblau: rgb(100,160,220);
    /* Rollenfarben */
    --role-admin-bg: #ffe8e6;
    --role-admin-bd: #ffcdc6;
    --role-admin-fg: #9e1b1b;
    --role-gl-bg: #fff6db;
    --role-gl-bd: #fde8a6;
    --role-gl-fg: #8a6b00;
    --role-hf-bg: #e8f6ec;
    --role-hf-bd: #c7efd5;
    --role-hf-fg: #0f6b2b;
    --role-an-bg: #e6f0ff;
    --role-an-bd: #cfe1ff;
    --role-an-fg: #0d3b8a;
  }

  * {
    box-sizing: border-box;
  }

  .material-page {
    color: var(--text);
    padding: 1rem;
  }

  .material-page .page-title {
    color: var(--softrot);
    margin: 0 0 1rem;
  }

  .material-page .material-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
  }

  @media (max-width: 980px) {
    .material-page .material-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Hintergrundfarbe für die Karten auf Weiß setzen */
  .material-page .card {
    background: #fff !important; /* Setzt den Hintergrund auf Weiß */
    padding: 1.25rem;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    margin-bottom: 1.5rem;
    border: 1px solid var(--material-bd); /* Der Rand bleibt korrekt */
  }

  .material-page .card h3 {
    color: var(--hellblau);
    margin: 0 0 1rem;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .material-page .material-list {
    list-style: none;
    padding-left: 0;
    display: none;
    margin-top: 1rem;
  }

  .material-page .material-list.open {
    display: block;
  }

  .material-page .material-list li {
    padding: 0.8rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .material-page .material-list li:hover {
    background: var(--blassblau);
  }

  .material-page .btn {
    padding: 0.6rem 1.2rem;
    border-radius: 10px;
    background: var(--dunkelblau);
    color: white;
    font-size: 1rem;
    cursor: pointer;
  }

  .material-page .btn-primary {
    background: var(--dunkelblau);
  }

  .material-page .search-box {
    margin-bottom: 1.5rem;
    position: relative;
  }

  /* Anpassungen für das Suchfeld */
  .material-page input[type="text"] {
    padding: 8px 32px 8px 32px; /* Platz für die Lupe und Clear-Button */
    width: 100%;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 1rem;
    transition: border-color 0.15s ease;
  }

  /* Such-Icon im Suchfeld */
  .material-page i.bi-search {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    font-size: 1rem;
  }

  /* Clear-Button (wird angezeigt, wenn Text im Suchfeld ist) */
  #clearSearch {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 1.2rem;
    color: #6b7280;
    cursor: pointer;
    display: none;
  }

  /* Fokus auf das Suchfeld */
  .material-page input[type="text"]:focus {
    outline: none;
    border-color: var(--dunkelblau); /* Fokusfarbe */
  }

  /* Clear-Button wird sichtbar, wenn das Eingabefeld Text enthält */
  .material-page input[type="text"]:not(:placeholder-shown) + #clearSearch {
    display: block;
  }
</style>
</head>

<body>
  <div class="material-page">
    <h2 class="page-title">Materialien</h2>
    <div class="search-box">
      <!-- Suchfeld mit Lupe und Clear-Button -->
      <div style="position:relative; margin:12px 0 14px;">
        <i class="bi bi-search" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#6b7280; font-size:1rem;"></i>
        <input type="text" id="searchInput" placeholder="Suchen..." style="padding:8px 32px 8px 32px; width:100%; border-radius:8px; border:1px solid #ccc;">
        <button id="clearSearch" type="button" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; font-size:1.2rem; color:#6b7280; cursor:pointer; display:none;">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
    </div>

    <div class="material-grid">
      <!-- Globale Materialien -->
      <div class="card material-global">
        <h3 onclick="toggleList('global')"><i class="bi bi-box"></i> Globale Materialien</h3>
        <ul class="material-list" id="globalMaterialsList"></ul>
        <button class="btn btn-primary" id="addGlobalMaterialBtn"><i class="bi bi-plus-circle"></i> Material hinzufügen</button>
        <button class="btn btn-primary" id="addGlobalFolderBtn"><i class="bi bi-folder-plus"></i> Ordner hinzufügen</button>
      </div>

      <!-- Persönliche Materialien -->
      <div class="card material-personal">
        <h3 onclick="toggleList('personal')"><i class="bi bi-person-circle"></i> Persönliche Materialien</h3>
        <ul class="material-list" id="personalMaterialsList"></ul>
        <button class="btn btn-primary" id="addPersonalMaterialBtn"><i class="bi bi-plus-circle"></i> Material hinzufügen</button>
        <button class="btn btn-primary" id="addPersonalFolderBtn"><i class="bi bi-folder-plus"></i> Ordner hinzufügen</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase Initialisierung
    import { initializeApp } from "firebase/app";
    import { getFirestore } from "firebase/firestore";
    import { getStorage } from "firebase/storage";
    import { getAuth, onAuthStateChanged } from "firebase/auth";

    const firebaseConfig = {
      apiKey: "AIzaSyDIuKwYoKQDyzy6qpmY2LGahJofZx6qnuw",
      authDomain: "iuk-app.firebaseapp.com",
      projectId: "iuk-app",
      storageBucket: "iuk-app.firebasestorage.app",
      messagingSenderId: "759014128178",
      appId: "1:759014128178:web:09c3690cd95b402c8ada2b",
      measurementId: "G-ZPD5VPD5TS"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    // Global and Personal Materials Placeholder
    let globalMaterials = [];
    let personalMaterials = [];
    let currentUser = null;
    let isAdminOrGL = false;

    // Listen for auth changes
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        checkUserRole(user);
        loadMaterials();
      }
    });

    // Funktion zum Rendern der Materialien
    function renderMaterials(materials, listElement) {
      listElement.innerHTML = "";
      materials.forEach(material => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${material.name}</strong><br>${material.description}`;
        listElement.appendChild(li);
      });
    }

    // Materialien laden
    async function loadMaterials() {
      if (currentUser) {
        // Globale Materialien für alle Benutzer anzeigen
        const globalSnapshot = await db.collection("globalMaterials").get();
        globalMaterials = globalSnapshot.docs.map(doc => doc.data());
        renderMaterials(globalMaterials, globalMaterialsList);

        // Persönliche Materialien nur für den aktuellen Benutzer
        const personalSnapshot = await db.collection("users").doc(currentUser.uid).collection("personalMaterials").get();
        personalMaterials = personalSnapshot.docs.map(doc => doc.data());
        renderMaterials(personalMaterials, personalMaterialsList);
      }
    }

    // Überprüfen, ob der Benutzer Admin oder Gruppenleiter ist
    async function checkUserRole(user) {
      const userClaims = await user.getIdTokenResult();
      isAdminOrGL = userClaims.claims.admin || userClaims.claims.gruppenleiter;
    }

    // Liste toggeln (ein- und ausklappen)
    function toggleList(type) {
      const list = document.getElementById(`${type}MaterialsList`);
      list.classList.toggle('open');
    }

    // Datei hochladen und speichern (Firebase Storage) - nur für Admins oder Gruppenleiter
    document.getElementById("addGlobalMaterialBtn").addEventListener("click", async () => {
      if (!isAdminOrGL) {
        alert("Nur Admins und Gruppenleiter dürfen Materialien hochladen!");
        return;
      }

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = ".pdf,.jpg,.jpeg,.png";  // Akzeptierte Dateiformate
      fileInput.onchange = async (e) => {
        const file = e.target.files[0]; // Die hochgeladene Datei

        // Erstelle einen Speicherort im Firebase Storage
        const storageRef = storage.ref().child(`materials/${file.name}`);

        try {
          // Lade die Datei hoch
          await storageRef.put(file);

          // Hole die URL der hochgeladenen Datei
          const fileUrl = await storageRef.getDownloadURL();

          // Speichere die Metadaten (Name, Beschreibung, URL) in Firestore
          await db.collection("globalMaterials").add({
            name: file.name,
            description: "Beschreibung für " + file.name,
            fileUrl: fileUrl,
          });

          alert("Material erfolgreich hochgeladen!");
          loadMaterials();  // Materialien neu laden
        } catch (error) {
          console.error("Fehler beim Hochladen:", error);
          alert("Es gab einen Fehler beim Hochladen des Materials.");
        }
      };

      fileInput.click(); // Öffne das Datei-Auswahlfenster
    });

    // Ordner hinzufügen (in Firebase Storage)
    document.getElementById("addGlobalFolderBtn").addEventListener("click", async () => {
      if (!isAdminOrGL) {
        alert("Nur Admins und Gruppenleiter dürfen Ordner hinzufügen!");
        return;
      }

      const folderName = prompt("Bitte geben Sie den Ordnernamen ein:");
      if (folderName) {
        // Erstelle einen 'leeren' Ordnerpfad im Firebase Storage
        const folderRef = storage.ref().child(`materials/${folderName}/`); // Hier ist der Ordnerpfad
        alert(`Ordner '${folderName}' erfolgreich erstellt!`);
      }
    });

    // Suchfeld für Materialien
    const searchInput = document.getElementById("searchInput");
    const clearSearch = document.getElementById("clearSearch");

    searchInput.addEventListener("input", () => {
      const query = searchInput.value.toLowerCase();
      const filteredGlobal = globalMaterials.filter(m => m.name.toLowerCase().includes(query) || m.description.toLowerCase().includes(query));
      const filteredPersonal = personalMaterials.filter(m => m.name.toLowerCase().includes(query) || m.description.toLowerCase().includes(query));

      renderMaterials(filteredGlobal, globalMaterialsList);
      renderMaterials(filteredPersonal, personalMaterialsList);

      clearSearch.style.display = searchInput.value ? "block" : "none";
    });

    clearSearch.addEventListener("click", () => {
      searchInput.value = "";
      clearSearch.style.display = "none";
      renderMaterials(globalMaterials, globalMaterialsList);
      renderMaterials(personalMaterials, personalMaterialsList);
    });
  </script>
</body>
</html>
