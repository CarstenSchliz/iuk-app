<h2 class="page-title">Lernmaterialien</h2>

<div class="card">
  <h3><i class="bi bi-folder"></i> Materialien</h3>
  <div id="materialsTree" class="tree"></div>

  <!-- Buttons zum Erstellen von Ordnern und Dateien -->
  <button id="createFolderBtn">Neuen Ordner erstellen</button>
  <button id="createFileBtn">Neue Datei hinzufügen</button>
</div>

<style>
  :root {
    --softrot: rgb(228,100,80);
    --dunkelblau: rgb(0,45,85);
    --hellgrau: rgb(239,238,234);
    --blassblau: rgb(230,240,250);
  }

  .page-title {
    color: var(--softrot);
    margin-bottom: 1rem;
  }

  .card {
    background: var(--card-bg, #fff);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }

  .tree ul {
    list-style: none;
    margin-left: 1.5rem;
    padding-left: 0.5rem;
    border-left: 2px solid var(--blassblau);
  }

  .tree li {
    margin: 0.5rem 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .tree li i {
    color: var(--dunkelblau);
  }

  .tree li span {
    flex-grow: 1;
  }

  .tree li:hover {
    background: var(--blassblau);
    border-radius: 6px;
    padding: 0.2rem 0.5rem;
  }

  /* Unterordner standardmäßig verstecken */
  .tree ul ul {
    display: none;
  }

  /* Button Styling */
  button {
    padding: 0.5rem;
    margin: 1rem 0;
    background-color: var(--softrot);
    color: white;
    border: none;
    cursor: pointer;
  }

  button:hover {
    background-color: var(--dunkelblau);
  }
</style>

<script type="module">
  import { auth, db } from "../js/firebase.js"; // Firebase Import

  const treeContainer = document.getElementById("materialsTree");

  // Funktion zum Laden der Materialien aus Firestore
  async function loadMaterials() {
    const user = auth.currentUser;
    if (!user) {
      console.log("Kein Benutzer eingeloggt");
      return;
    }

    const materials = {
      global: { type: "folder", name: "Global", children: {} },
      user: { type: "folder", name: "Mein Ordner", children: {} }
    };

    try {
      // Abrufen des globalen Ordners
      const globalDoc = await db.collection("materials").doc("global").get();
      if (globalDoc.exists) {
        const globalData = globalDoc.data();
        materials.global.children = globalData.children || {};
      }

      // Abrufen des persönlichen Ordners des Benutzers
      const userDoc = await db.collection("materials").doc(user.uid).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        materials.user.children = userData.children || {};
      }

      renderTree(materials, treeContainer);
    } catch (error) {
      console.error("Fehler beim Laden der Materialien:", error);
    }
  }

  // Funktion zur Darstellung der Baumstruktur
  function renderTree(node, container) {
    const ul = document.createElement("ul");
    for (const key in node) {
      const item = node[key];
      const li = document.createElement("li");

      if (item.type === "folder") {
        li.innerHTML = `<i class="bi bi-folder"></i><span>${item.name}</span>`;
        renderTree(item.children, li);

        // Event-Listener für das Klicken und Umschalten der Unterordner
        li.addEventListener("click", (e) => {
          e.stopPropagation();  // Verhindert das event bubbling
          const child = li.querySelector("ul");
          if (child) {
            child.style.display = child.style.display === "none" ? "block" : "none";
          }
        });
      } else if (item.type === "file") {
        li.innerHTML = `<i class="bi bi-file-earmark"></i>
                        <a href="${item.url}" target="_blank">${item.name}</a>`;
      }

      ul.appendChild(li);
    }
    container.appendChild(ul);
  }

  // Funktion zum Erstellen eines Ordners
  async function createFolder() {
    const user = auth.currentUser;
    const folderName = prompt("Gib den Namen des neuen Ordners ein:");

    if (folderName) {
      const userRef = db.collection("materials").doc(user.uid);
      const userDoc = await userRef.get();

      let userData = userDoc.data() || { children: {} };
      userData.children[folderName] = { type: "folder", name: folderName, children: {} };

      await userRef.set(userData); // Speichern des neuen Ordners in Firestore
      loadMaterials(); // Neu laden der Materialien
    }
  }

  // Funktion zum Erstellen einer Datei
  async function createFile() {
    const user = auth.currentUser;
    const fileName = prompt("Gib den Namen der neuen Datei ein:");

    if (fileName) {
      const userRef = db.collection("materials").doc(user.uid);
      const userDoc = await userRef.get();

      let userData = userDoc.data() || { children: {} };
      userData.children[fileName] = { type: "file", name: fileName, url: "#" };

      await userRef.set(userData); // Speichern der neuen Datei in Firestore
      loadMaterials(); // Neu laden der Materialien
    }
  }

  // Event Listener für Buttons
  document.getElementById("createFolderBtn").addEventListener("click", createFolder);
  document.getElementById("createFileBtn").addEventListener("click", createFile);

  // Materialien beim Laden der Seite laden
  window.addEventListener('DOMContentLoaded', loadMaterials);
</script>
