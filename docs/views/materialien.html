<h2 class="page-title">Lernmaterialien</h2>

<div class="card">
  <h3><i class="bi bi-folder"></i> Materialien</h3>
  <div id="materialsTree" class="tree"></div>
</div>

<style>
  :root {
    --softrot: rgb(228,100,80);
    --dunkelblau: rgb(0,45,85);
    --hellgrau: rgb(239,238,234);
    --blassblau: rgb(230,240,250);
  }

  .page-title {
    color: var(--softrot);
    margin-bottom: 1rem;
  }

  .card {
    background: var(--card-bg, #fff);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }

  .tree ul {
    list-style: none;
    margin-left: 1.5rem;
    padding-left: 0.5rem;
    border-left: 2px solid var(--blassblau);
  }

  .tree li {
    margin: 0.5rem 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .tree li i {
    color: var(--dunkelblau);
  }

  .tree li span {
    flex-grow: 1;
  }

  .tree li:hover {
    background: var(--blassblau);
    border-radius: 6px;
    padding: 0.2rem 0.5rem;
  }

  /* Darkmode */
  body.dark .card {
    background: #1e1e1e;
    color: #f0f0f0;
  }
  body.dark .tree ul {
    border-left-color: #444;
  }
  body.dark .tree li:hover {
    background: #333;
  }

  .tree ul ul {
    display: none; /* Unterordner sind anfangs verborgen */
  }

</style>

<script type="module">
  console.log("✅ materialien.html geladen");

  import { auth, db } from "../js/firebase.js"; // Firebase Import

  const treeContainer = document.getElementById("materialsTree");

  // Funktion, um die Materialien von Firestore zu laden
  async function loadMaterials() {
    const user = auth.currentUser;
    if (!user) return;

    const materials = {
      global: { type: "folder", name: "Global", children: {} },
      user: { type: "folder", name: "Mein Ordner", children: {} }
    };

    try {
      // Abrufen des globalen Ordners
      const globalDoc = await db.collection("materials").doc("global").get();
      if (globalDoc.exists) {
        const globalData = globalDoc.data();
        materials.global.children = globalData.children || {};
      }

      // Abrufen des persönlichen Ordners des Benutzers
      const userDoc = await db.collection("materials").doc(user.uid).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        materials.user.children = userData.children || {};
      }

      // Baum rendern
      renderTree(materials, treeContainer);
    } catch (error) {
      console.error("Fehler beim Laden der Materialien:", error);
    }
  }

  // Funktion zum Erstellen der Baumstruktur
  function renderTree(node, container) {
    const ul = document.createElement("ul");
    for (const key in node) {
      const item = node[key];
      const li = document.createElement("li");

      if (item.type === "folder") {
        li.innerHTML = `<i class="bi bi-folder"></i><span>${item.name}</span>`;
        renderTree(item.children, li);
        
        // Event-Listener für das Klicken und Umschalten der Unterordner
        li.addEventListener("click", (e) => {
          e.stopPropagation();  // Verhindert das event bubbling
          const child = li.querySelector("ul");
          if (child) {
            child.style.display = child.style.display === "none" ? "block" : "none";
          }
        });
      } else if (item.type === "file") {
        li.innerHTML = `<i class="bi bi-file-earmark"></i>
                        <a href="${item.url}" target="_blank">${item.name}</a>`;
      }

      ul.appendChild(li);
    }
    container.appendChild(ul);
  }

  // Materialien laden, wenn die Seite geladen wird
  window.addEventListener('DOMContentLoaded', loadMaterials);
</script>
