<!-- public/views/persoenlich.html -->
<h1 style="color: var(--softrot);">Einstellungen</h1>

<!-- Persönliche Daten -->
<div class="card">
  <h2 style="color: var(--dunkelblau);">Persönliche Daten</h2>
  <form id="personalForm">
    <div class="form-group">
      <input type="text" id="name" required placeholder=" ">
      <label for="name">Name</label>
    </div>

    <div class="form-group">
      <input type="email" id="email" disabled placeholder=" ">
      <label for="email">E-Mail-Adresse</label>
    </div>

    <div class="form-row">
      <div class="form-group">
        <input type="tel" id="mobile" placeholder=" ">
        <label for="mobile">Mobiltelefon</label>
      </div>
      <div class="form-group">
        <input type="tel" id="phone" placeholder=" ">
        <label for="phone">Telefonnummer</label>
      </div>
    </div>

    <button type="submit" class="btn-save">Speichern</button>
  </form>
</div>

<!-- Passwort ändern -->
<div class="card">
  <h2 style="color: var(--dunkelblau);">Passwort ändern</h2>
  <form id="passwordForm">
    <div class="form-group">
      <input type="password" id="currentPassword" required placeholder=" ">
      <label for="currentPassword">Aktuelles Passwort</label>
    </div>
    <div class="form-group">
      <input type="password" id="newPassword" required placeholder=" ">
      <label for="newPassword">Neues Passwort</label>
    </div>
    <div class="form-group">
      <input type="password" id="confirmPassword" required placeholder=" ">
      <label for="confirmPassword">Neues Passwort bestätigen</label>
    </div>
    <button type="submit" class="btn-save">Passwort ändern</button>
  </form>
</div>

<!-- Benachrichtigungen -->
<div class="card">
  <h2 style="color: var(--dunkelblau);">Benachrichtigungen</h2>
  <label><input type="checkbox" id="notifyEmail"> E-Mail-Benachrichtigungen</label><br>
  <label><input type="checkbox" id="notifySMS"> SMS-Benachrichtigungen</label>
</div>

<!-- Erscheinungsbild -->
<div class="card">
  <h2 style="color: var(--dunkelblau);">Erscheinungsbild</h2>
  <button id="toggleThemeBtn" class="btn-dark">Zu Dunkelmodus wechseln</button>
</div>

<style>
  .card {
    background: #fff;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  .form-group {
    position: relative;
    margin-bottom: 1.5rem;
  }

  .form-group input {
    width: 100%;
    padding: 1rem 0.75rem 0.5rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    background: transparent;
    font-size: 1rem;
    outline: none;
  }

  .form-group label {
    position: absolute;
    left: 0.75rem;
    top: 1rem;
    font-size: 1rem;
    color: #666;
    pointer-events: none;
    transition: 0.2s ease all;
    background: #fff;
    padding: 0 0.25rem;
  }

  .form-group input:focus + label,
  .form-group input:not(:placeholder-shown) + label {
    top: -0.6rem;
    font-size: 0.8rem;
    color: var(--dunkelblau);
  }

  .form-row {
    display: flex;
    gap: 1rem;
  }

  .form-row .form-group {
    flex: 1;
  }

  .btn-save {
    background: var(--softrot);
    color: #fff;
    border: none;
    padding: 0.8rem 1.2rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
  }

  .btn-dark {
    background: var(--dunkelblau);
    color: #fff;
    border: none;
    padding: 0.8rem 1.2rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
  }

  @media (max-width: 768px) {
    .form-row {
      flex-direction: column;
    }
  }
</style>

<script type="module">
  import { auth, updateUserProfile, observeAuthState } from "../js/firebase.js";
  import { updatePassword, reauthenticateWithCredential, EmailAuthProvider } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const form = document.getElementById("personalForm");
  const nameInput = document.getElementById("name");
  const emailInput = document.getElementById("email");
  const mobileInput = document.getElementById("mobile");
  const phoneInput = document.getElementById("phone");

  // User-Daten laden
  observeAuthState(user => {
    if (user) {
      nameInput.value = user.displayName || "";
      emailInput.value = user.email || "";
    }
  });

  // Persönliche Daten speichern
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (user) {
      try {
        await updateUserProfile(user, { displayName: nameInput.value });
        // Sidebar Name updaten
        const sidebarName = document.getElementById("userName");
        if (sidebarName) sidebarName.textContent = nameInput.value;
        alert("Änderungen gespeichert!");
      } catch (err) {
        alert("Fehler: " + err.message);
      }
    }
  });

  // Passwort ändern
  const passwordForm = document.getElementById("passwordForm");
  passwordForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    const currentPw = document.getElementById("currentPassword").value;
    const newPw = document.getElementById("newPassword").value;
    const confirmPw = document.getElementById("confirmPassword").value;

    if (newPw !== confirmPw) {
      alert("Die neuen Passwörter stimmen nicht überein.");
      return;
    }

    try {
      const cred = EmailAuthProvider.credential(user.email, currentPw);
      await reauthenticateWithCredential(user, cred);
      await updatePassword(user, newPw);
      alert("Passwort erfolgreich geändert!");
      passwordForm.reset();
    } catch (err) {
      alert("Fehler: " + err.message);
    }
  });

  // Darkmode umschalten
  document.getElementById("toggleThemeBtn").addEventListener("click", () => {
    window.dispatchEvent(new Event("toggleTheme"));
  });
</script>
