<div class="user-page">
  <h2 class="page-title">Benutzerverwaltung</h2>

  <style>
    .user-page {
      padding: 1rem;
    }

    .user-page .page-title {
      color: var(--softrot);
      margin: 0 0 1rem;
    }

    .user-page .settings-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.5rem;
      align-items: start;
    }
    @media (max-width:980px) {
      .user-page .settings-grid {
        grid-template-columns: 1fr;
      }
    }

    .user-page .card {
      background: #fff;
      padding: 1.25rem;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
    }
    .user-page .card h3 {
      color: var(--hellblau); /* Überschriften hellblau */
      margin: 0 0 1rem;
      font-size: 1.1rem;
      display:flex;
      align-items:center;
      gap:0.5rem;
    }

    /* Tabelle */
    .user-page .user-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .95rem;
      table-layout: fixed;
    }
    .user-page .user-table th,
    .user-page .user-table td {
      border-bottom: 1px solid #e5e7eb;
      padding: .6rem .5rem;
      vertical-align: middle;
      text-align: left;
    }
    .user-page .user-table th {
      background: var(--dunkelblau); /* Tabellenkopf dunkelblau */
      color: #fff;                   /* Text weiß */
    }

    .user-page .nowrap {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .user-page .td-name b {
      font-weight: 700;
    }
    .user-page .td-roles {
      white-space: normal;
    }

    /* Rollen-Badges */
    .user-page .role-badges {
      display: flex;
      gap: .35rem;
      flex-wrap: wrap;
    }
    .user-page .role-badge {
      display: inline-block;
      padding: .18rem .55rem;
      border-radius: 999px;
      font-size: .78rem;
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .user-page .role-admin { background:#ffe8e6; border-color:#ffcdc6; color:#9e1b1b; }
    .user-page .role-gl {    background:#fff6db; border-color:#fde8a6; color:#8a6b00; }
    .user-page .role-hf {    background:#e8f6ec; border-color:#c7efd5; color:#0f6b2b; }
    .user-page .role-an {    background:#e6f0ff; border-color:#cfe1ff; color:#0d3b8a; }

    /* Actions */
    .user-page .actions-cell {
      position: relative;
      width: 44px;
      text-align: right;
    }
    .user-page .kebab-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: .3rem .4rem;
      font-size: 1.2rem;
      color: #374151;
      border-radius: 8px;
      display: inline-flex;
      line-height: 1;
      vertical-align: middle;
      pointer-events: auto;
    }
    .user-page .kebab-menu {
      position: absolute;
      right: 0;
      top: calc(100% + 6px);
      min-width: 200px;
      z-index: 999;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.12);
      display: none;
      overflow: hidden;
    }
    .user-page .kebab-menu button {
      width: 100%;
      background: transparent;
      border: none;
      text-align: left;
      cursor: pointer;
      padding: .7rem .9rem;
      font-size: .92rem;
      display: flex;
      gap: .5rem;
      align-items: center;
    }
    .user-page .kebab-menu button:hover {
      background: #f8fafc;
    }

    .user-page .form-msg {
      margin-top: .5rem;
      font-weight: 600;
    }

    /* Floating fields */
    .user-page .form-group.floating {
      position: relative;
      margin-bottom: 1.25rem;
    }
    .user-page .form-group.floating input {
      width: 100%;
      padding: 1rem .75rem .3rem .75rem;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      background: #fff;
      font-size: 1rem;
      transition: border-color .15s ease;
      min-height: 44px;
    }
    .user-page .form-group.floating label {
      position: absolute;
      top: 50%;
      left: .75rem;
      transform: translateY(-50%);
      color: #6b7280;
      font-size: .95rem;
      transition: all .15s;
      pointer-events: none;
      background: #fff;
      padding: 0 .25rem;
    }
    .user-page .form-group.floating input:focus + label,
    .user-page .form-group.floating input:not(:placeholder-shown) + label {
      top: 0;
      left: .6rem;
      font-size: .78rem;
      color: var(--dunkelblau);
    }

    /* Buttons */
    .user-page .btn { padding:.6rem .9rem; border:none; border-radius:10px; cursor:pointer; font-size:.95rem; min-height:44px }
    .user-page .btn-primary { background:var(--dunkelblau); color:#fff }
    .user-page .btn-secondary { background:#eef2f7 }
    .user-page .btn-danger { background:#c62828; color:#fff }

    /* Editor */
    .user-page #editPanelOuter { display:none }

    .user-page .editor-actions {
      display:flex;
      gap:.8rem;
      margin-top:1.1rem;
    }
    .user-page .editor-actions .btn { width:auto }

    /* Toast */
    .user-page #toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #243244;
      padding: .8rem 1rem;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      display: none;
      z-index: 1000;
    }
  </style>

  <div class="settings-grid">
    <!-- Nutzerliste -->
    <div class="card">
      <h3><i class="bi bi-people"></i> Benutzerübersicht</h3>

      <table class="user-table" aria-label="Liste der Benutzer">
        <thead>
          <tr>
            <th>Anzeigename</th>
            <th>E-Mail-Adresse</th>
            <th>Rollen</th>
            <th style="width:44px;"></th>
          </tr>
        </thead>
        <tbody id="userList"></tbody>
      </table>

      <div id="userMsg" class="form-msg"></div>
    </div>

    <!-- Neuer Nutzer -->
    <div>
      <div class="card">
        <h3><i class="bi bi-person-plus"></i> Neuen Nutzer anlegen</h3>
        <form id="createUserForm" novalidate>
          <div class="form-group floating">
            <input type="email" id="newEmail" placeholder=" " required inputmode="email" autocomplete="email" />
            <label for="newEmail">E-Mail</label>
          </div>
          <div class="form-group floating">
            <input type="password" id="newPassword" placeholder=" " required autocomplete="new-password" minlength="6" />
            <label for="newPassword">Passwort</label>
          </div>
          <div class="form-group floating">
            <input type="text" id="newName" placeholder=" " autocomplete="name" />
            <label for="newName">Anzeigename (optional)</label>
          </div>
          <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Benutzer erstellen</button>
          <div id="createUserMsg" class="form-msg"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- SEPARATER Editor-Kasten -->
  <div id="editPanelOuter" class="card" style="display:none;">
    <div id="editPanel"></div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>
</div>

<script type="module">
  const API_BASE = "https://us-central1-iuk-app.cloudfunctions.net";

  const userList = document.getElementById("userList");
  const userMsg  = document.getElementById("userMsg");
  const editPanelOuter = document.getElementById("editPanelOuter");
  const editPanel = document.getElementById("editPanel");
  const toastEl = document.getElementById("toast");

  const ROLE_DEF = [
    { key:"admin",         label:"Admin",         cls:"role-admin" },
    { key:"gruppenleiter", label:"Gruppenleiter", cls:"role-gl" },
    { key:"helfer",        label:"Helfer",        cls:"role-hf" },
    { key:"anwärter",      label:"Anwärter",      cls:"role-an" },
  ];

  const showToast = (msg) => {
    toastEl.textContent = msg; toastEl.style.display = "block";
    clearTimeout(showToast._t); showToast._t = setTimeout(()=> toastEl.style.display = "none", 2600);
  };

  function extractRoles(u){
    let roles = Array.isArray(u.roles) ? u.roles : [];
    if (!roles.length){
      ROLE_DEF.forEach(r => { if (u[r.key]) roles.push(r.key); });
      if (u.admin && !roles.includes("admin")) roles.push("admin");
    }
    const allowed = new Set(ROLE_DEF.map(r=>r.key));
    return Array.from(new Set(roles.filter(r=>allowed.has(r))));
  }

  function rolesToBadges(roles){
    if (!roles?.length) return '<span style="color:#9ca3af">–</span>';
    return '<div class="role-badges">' + roles.map(r=>{
      const def = ROLE_DEF.find(d=>d.key===r);
      return `<span class="role-badge ${def?.cls||""}">${def?.label||r}</span>`;
    }).join("") + '</div>';
  }

  function buildKebab(cell, onEdit, onDelete, user){
    cell.classList.add("actions-cell");
    const btn = document.createElement("button");
    btn.className = "kebab-btn"; btn.setAttribute("aria-label","Aktionen");
    btn.innerHTML = '<i class="bi bi-three-dots-vertical"></i>';

    const menu = document.createElement("div");
    menu.className = "kebab-menu";
    menu.innerHTML = `
      <button class="act-edit"><i class="bi bi-pencil"></i><span>Bearbeiten</span></button>
      <button class="act-del"  style="color:#b91c1c;"><i class="bi bi-trash"></i><span>Nutzer löschen</span></button>
    `;

    const openMenu = (e) => {
      e?.stopPropagation?.();
      const isOpen = menu.style.display === "block";
      document.querySelectorAll(".user-page .kebab-menu").forEach(m=>m.style.display="none");
      menu.style.display = isOpen ? "none" : "block";
    };

    btn.addEventListener("click", openMenu, { passive:true });
    btn.addEventListener("touchstart", openMenu, { passive:true });

    const closeAll = () => menu.style.display = "none";
    document.addEventListener("click", closeAll);
    document.addEventListener("touchstart", closeAll, { passive:true });

    menu.querySelector(".act-edit").addEventListener("click", ()=>{ menu.style.display="none"; onEdit(user); });
    menu.querySelector(".act-del").addEventListener("click", ()=>{ menu.style.display="none"; onDelete(user); });

    cell.appendChild(btn); cell.appendChild(menu);
  }

  function openEditor(user){
    const initial = {
      name: user.displayName || "",
      roles: extractRoles(user)
    };

    editPanelOuter.style.display = "block";
    editPanel.innerHTML = `
      <h3 style="margin-top:0;">Nutzer bearbeiten</h3>

      <div class="editor-row">
        <div class="form-group floating">
          <input type="text" id="edName" placeholder=" " value="${initial.name}">
          <label for="edName">Anzeigename</label>
        </div>
        <div class="form-group floating">
          <input type="email" id="edEmail" placeholder=" " value="${user.email || ""}" readonly>
          <label for="edEmail">E-Mail-Adresse</label>
        </div>
        <div class="form-group floating">
          <input type="text" id="edUID" placeholder=" " value="${user.uid}" readonly>
          <label for="edUID">UID</label>
        </div>
      </div>

      <div id="rolesSection">
        <h4>Rollen</h4>
        <div class="roles-grid">
          ${ROLE_DEF.map(r => `
            <label class="role-check">
              <input type="checkbox" value="${r.key}" ${initial.roles.includes(r.key) ? "checked":""} />
              <span class="role-badge ${r.cls}">${r.label}</span>
            </label>
          `).join("")}
        </div>
      </div>

      <div class="editor-actions">
        <button class="btn btn-secondary" id="edCancel"><i class="bi bi-x-lg"></i> Abbrechen</button>
        <button class="btn btn-primary"  id="edSave"><i class="bi bi-save"></i> Speichern</button>
      </div>
    `;

    document.getElementById("edCancel").onclick = () => {
      showToast("Änderungen verworfen");
      editPanelOuter.style.display = "none";
      editPanel.innerHTML = "";
    };

    document.getElementById("edSave").onclick = async () => {
      const newName = document.getElementById("edName").value.trim();
      const selected = Array.from(editPanel.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);

      try{
        const res = await fetch(API_BASE + "/updateUser", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ uid: user.uid, displayName: newName, roles: selected })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Unbekannter Fehler");

        showToast("Gespeichert");
        await loadUsers();
        editPanelOuter.style.display = "none";
        editPanel.innerHTML = "";
      }catch(err){
        showToast("Fehler: " + err.message);
      }
    };
  }

  async function deleteUserFlow(user){
    if (!confirm("Soll der Nutzer wirklich gelöscht werden?\n\n" + (user.displayName || user.email || user.uid))) return;

    try{
      const res = await fetch(API_BASE + "/deleteUser", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ uid: user.uid })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Unbekannter Fehler");
      showToast("Nutzer gelöscht");
      await loadUsers();
      editPanelOuter.style.display = "none"; editPanel.innerHTML = "";
    }catch(err){
      showToast("Fehler: " + err.message);
    }
  }

  function renderUsers(users){
    userList.innerHTML = "";
    users.forEach(u=>{
      const tr = document.createElement("tr");
      const name = u.displayName || "Ohne Namen";
      const mail = u.email || "–";
      const roles = extractRoles(u);

      tr.innerHTML = `
        <td class="nowrap td-name" data-label="Anzeigename" title="${name}"><b>${name}</b></td>
        <td class="nowrap" data-label="E-Mail-Adresse" title="${mail}"><span class="email-val">${mail}</span></td>
        <td class="td-roles" data-label="Rollen">${rolesToBadges(roles)}</td>
        <td class="actions-cell" data-label=""></td>
      `;
      const actionsCell = tr.querySelector(".actions-cell");
      buildKebab(actionsCell, openEditor, deleteUserFlow, { uid: u.uid, displayName:name, email:mail, roles });

      userList.appendChild(tr);
    });
  }

  async function loadUsers(){
    userMsg.style.color = "orange";
    userMsg.textContent = "⏳ Lade Nutzer...";
    try{
      const res = await fetch(API_BASE + "/listUsers", { method:"GET" });
      const data = await res.json();
      renderUsers(data.users || []);
      userMsg.textContent = "";
    }catch(err){
      userMsg.style.color = "red";
      userMsg.textContent = "❌ Fehler beim Laden der Nutzer: " + err.message;
    }
  }

  loadUsers();

  const form = document.getElementById("createUserForm");
  const msg  = document.getElementById("createUserMsg");
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const email = document.getElementById("newEmail").value.trim();
    const pw    = document.getElementById("newPassword").value;
    const name  = document.getElementById("newName").value.trim();

    if (!email || !pw){
      msg.style.color = "red"; msg.textContent = "❌ E-Mail und Passwort sind erforderlich.";
      return;
    }
    msg.textContent = "";

    try{
      const res = await fetch(API_BASE + "/createUser", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ email, password: pw, displayName: name })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Unbekannter Fehler");

      showToast("Benutzer erstellt");
      form.reset();
      await loadUsers();
    }catch(err){
      msg.style.color = "red"; msg.textContent = "❌ Fehler: " + err.message;
    }
  });
</script>
