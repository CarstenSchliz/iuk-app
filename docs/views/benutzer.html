<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>IuK Lernwelt – Benutzerverwaltung</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#002D55" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

  <style>
    :root {
      --softrot: rgb(228,100,80);
      --dunkelblau: rgb(0,45,85);
      --hellgrau: rgb(239,238,234);
      --mittelgrau: rgb(180,180,180);
      --blassblau: rgb(230,240,250);
      --hoverblau: #cfe4f9;
      --text: #1f2937;
    }

    /* App-Shell Layout (wie deine Shell-Seite) */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: var(--hellgrau);
      overflow: hidden;
      color: var(--text);
    }

    /* Sidebar */
    .sidebar {
      background: #fff;
      width: 300px;
      display: flex;
      flex-direction: column;
      padding: 1.5rem 1rem;
      box-sizing: border-box;
    }
    .profile { text-align: center; margin-bottom: 2rem; }
    .profile img {
      width: 100px; aspect-ratio: 1/1; border-radius: 50%; object-fit: cover;
      border: 2px solid #000; display: block; margin: 0 auto .8rem; background: #ccc; cursor: pointer;
    }
    .profile h2 { margin: 0; font-size: 1.2rem; color: #000; }
    .profile p { margin: 0; font-size: .9rem; color: #333; }
    .menu { flex-grow: 1; }
    .menu button, .logout {
      position: relative; display: flex; align-items: center; gap: .75rem;
      width: 100%; padding: .6rem 1rem; background: transparent; border: none; font-size: 1rem;
      cursor: pointer; text-align: left; border-radius: 8px; margin-bottom: .5rem; box-sizing: border-box;
      transition: background-color .25s ease, color .25s ease;
    }
    .menu button i { color: inherit; }
    .menu button:hover, .logout:hover { background: var(--hoverblau); }
    .menu button::before {
      content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 0;
      background: transparent; border-radius: 4px 0 0 4px; transition: width .25s ease, background-color .25s ease;
    }
    .menu button:hover::before { width: 5px; background: var(--hoverblau); }
    .menu button.active { background: var(--blassblau); font-weight: bold; color: var(--dunkelblau); }
    .menu button.active::before { width: 5px; background: var(--dunkelblau); }
    .logout { margin-top: auto; margin-bottom: .8rem; }
    .version { font-size: .8rem; text-align: center; color: #555; }

    /* Content */
    .content {
      flex-grow: 1;
      background: var(--hellgrau);
      padding: 2rem 3rem;
      overflow-y: auto;
    }

    /* Menü-Button mobil */
    .menu-toggle { display: none; }
    @media (max-width: 768px) {
      .sidebar {
        position: fixed; left: -260px; top: 0; height: 100%; width: 260px; transition: left .3s; z-index: 1000;
      }
      .sidebar.active { left: 0; }
      .menu-toggle {
        display: block; position: fixed; top: 1rem; left: 1rem; font-size: 1.5rem;
        background: var(--dunkelblau); color: white; border: none; padding: .5rem .8rem; border-radius: 8px; cursor: pointer; z-index: 1100;
      }
      .content { padding: 5rem 1.5rem 2rem; }
    }

    /* Darkmode Grundzüge (optional) */
    body.dark { background: #0d0d0d; color: #f5f5f5; }
    body.dark .sidebar { background: #1a1a1a; color: #f5f5f5; }
    body.dark .menu button, body.dark .logout { color: #f5f5f5; }
    body.dark .menu button:hover, body.dark .logout:hover { background: var(--hoverblau); color: #000; }
    body.dark .menu button.active { background: var(--blassblau); color: var(--dunkelblau); }
    body.dark .menu button.active::before { background: var(--dunkelblau); }
    body.dark .profile h2, body.dark .profile p { color: #f5f5f5; }

    /* ---------------- Benutzerseite (gekapselt) ---------------- */
    :where(.user-page) { color: var(--text); }
    :where(.user-page) .page-title { color: var(--softrot); margin: 0 0 1rem; }

    :where(.user-page) .settings-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; align-items: start; }
    @media (max-width: 980px){ :where(.user-page) .settings-grid{ grid-template-columns: 1fr } }

    :where(.user-page) .card{
      background:#fff; padding:1.25rem; border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.08); margin-bottom:1.5rem;
    }
    :where(.user-page) .card h3{ color: var(--dunkelblau); margin:0 0 1rem; font-size:1.1rem }

    /* Tabelle */
    :where(.user-page) .user-table{ width:100%; border-collapse:collapse; font-size:.95rem; table-layout:fixed }
    :where(.user-page) .user-table th, :where(.user-page) .user-table td{
      border-bottom:1px solid #e5e7eb; padding:.6rem .5rem; vertical-align:middle; text-align:left;
    }
    :where(.user-page) .user-table th{ background:var(--blassblau); }

    :where(.user-page) .nowrap{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    :where(.user-page) .td-name b{ font-weight:700 }
    :where(.user-page) .td-roles{ white-space:normal }

    /* Rollen-Badges */
    :where(.user-page) .role-badges{ display:flex; gap:.35rem; flex-wrap:wrap }
    :where(.user-page) .role-badge{ display:inline-block; padding:.18rem .55rem; border-radius:999px; font-size:.78rem; border:1px solid transparent; white-space:nowrap }
    :where(.user-page) .role-admin{ background:#ffe8e6; border-color:#ffcdc6; color:#9e1b1b }
    :where(.user-page) .role-gl{    background:#fff6db; border-color:#fde8a6; color:#8a6b00 }
    :where(.user-page) .role-hf{    background:#e8f6ec; border-color:#c7efd5; color:#0f6b2b }
    :where(.user-page) .role-an{    background:#e6f0ff; border-color:#cfe1ff; color:#0d3b8a }

    /* Actions */
    :where(.user-page) .actions-cell{ position:relative; width:44px; text-align:right }
    :where(.user-page) .kebab-btn{
      background:transparent; border:none; cursor:pointer; padding:.3rem .4rem;
      font-size:1.2rem; color:#374151; border-radius:8px; display:inline-flex; line-height:1;
    }
    :where(.user-page) .kebab-btn:focus-visible{ outline:2px solid var(--dunkelblau) }
    :where(.user-page) .kebab-menu{
      position:absolute; right:0; top:calc(100% + 6px); min-width:200px; z-index:9999;
      background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 12px 30px rgba(0,0,0,.12);
      display:none; overflow:hidden;
    }
    :where(.user-page) .kebab-menu button{
      width:100%; background:transparent; border:none; text-align:left; cursor:pointer;
      padding:.7rem .9rem; font-size:.92rem; display:flex; gap:.5rem; align-items:center
    }
    :where(.user-page) .kebab-menu button:hover{ background:#f8fafc }

    /* Floating fields */
    :where(.user-page) .form-group.floating{ position:relative; margin-bottom:1.25rem }
    :where(.user-page) .form-group.floating input{
      width:100%; padding:1rem .75rem .3rem .75rem; border:1px solid #d1d5db; border-radius:10px; background:#fff; font-size:1rem; transition:border-color .15s ease; min-height:44px;
    }
    :where(.user-page) .form-group.floating input:focus{ outline:none; border-color:var(--dunkelblau) }
    :where(.user-page) .form-group.floating label{
      position:absolute; top:50%; left:.75rem; transform:translateY(-50%); color:#6b7280; font-size:.95rem; transition:all .15s; pointer-events:none; background:#fff; padding:0 .25rem;
    }
    :where(.user-page) .form-group.floating input:focus + label,
    :where(.user-page) .form-group.floating input:not(:placeholder-shown) + label{
      top:0; left:.6rem; font-size:.78rem; color:var(--dunkelblau);
    }
    :where(.user-page) .form-group.floating input[readonly]{ background:#f9fafb; color:#6b7280 }

    /* Buttons */
    :where(.user-page) .btn{ padding:.6rem .9rem; border:none; border-radius:10px; cursor:pointer; font-size:.95rem; min-height:44px }
    :where(.user-page) .btn-primary{ background:var(--dunkelblau); color:#fff }
    :where(.user-page) .btn-secondary{ background:#eef2f7 }
    :where(.user-page) .btn-danger{ background:#c62828; color:#fff }

    /* Editor */
    :where(.user-page) #editPanelOuter{ display:none }
    :where(.user-page) #editPanel .editor-row{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:1.25rem; align-items:start; margin-bottom:.25rem }
    @media (max-width:900px){ :where(.user-page) #editPanel .editor-row{ grid-template-columns:1fr 1fr } }
    @media (max-width:640px){ :where(.user-page) #editPanel .editor-row{ grid-template-columns:1fr } }

    :where(.user-page) #rolesSection{ margin-top:1rem }
    :where(.user-page) #rolesSection h4{ margin:.2rem 0 .8rem; font-size:1.05rem; color:var(--dunkelblau); font-weight:700 }
    :where(.user-page) .roles-grid{ display:flex; gap:1rem 1.25rem; flex-wrap:wrap }
    :where(.user-page) .role-check{ display:flex; align-items:center; gap:.6rem; padding:.45rem .6rem; border-radius:12px; border:1px solid #e5e7eb; background:#fff }
    :where(.user-page) .role-check input[type="checkbox"]{ width:24px; height:24px; accent-color: var(--dunkelblau) }
    :where(.user-page) .role-check .role-badge{ font-size:.82rem }

    :where(.user-page) .editor-actions{ display:flex; gap:.8rem; margin-top:1.1rem }
    :where(.user-page) .editor-actions .btn{ width:auto }

    /* --- Mobile Kartenlayout + Kebab oben neben Name --- */
    @media (max-width:720px){
      :where(.user-page) .user-table thead{ display:none }
      :where(.user-page) .user-table, 
      :where(.user-page) .user-table tbody, 
      :where(.user-page) .user-table tr, 
      :where(.user-page) .user-table td{ display:block; width:100% }
      :where(.user-page) .user-table tr{
        position: relative; /* für Kebab oben rechts */
        background:#fff; border:1px solid #e5e7eb; border-radius:12px;
        padding:.6rem .6rem .2rem; margin-bottom:.8rem; box-shadow:0 1px 4px rgba(0,0,0,.06);
      }
      :where(.user-page) .user-table td{ border:none; padding:.35rem .25rem }
      /* nur zeigen, wenn Label vorhanden → verhindert „zwei Punkte“ bei Actions */
      :where(.user-page) .user-table td[data-label]:not([data-label=""])::before{
        content:attr(data-label) ": "; font-weight:600; color:#6b7280; display:inline-block; min-width:120px;
      }
      /* E-Mail unter Label, E-Mail selbst ohne Umbruch */
      :where(.user-page) .user-table td[data-label="E-Mail-Adresse"]::before{ display:block; margin-bottom:.15rem }
      :where(.user-page) .user-table td[data-label="E-Mail-Adresse"] .email-val{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block }
      /* Kebab oben rechts an der Karte (neben dem Namen-Bereich) */
      :where(.user-page) .actions-cell{
        position:absolute; top:.4rem; right:.4rem; width:auto; padding:0; text-align:right;
      }
      :where(.user-page) .actions-cell::before{ content:""; display:none !important; }
      /* Werte sonst dürfen umbrechen */
      :where(.user-page) .nowrap{ white-space:normal; overflow:visible; text-overflow:clip }
    }

    /* Toast (unten mittig, viewport-fixiert) */
    :where(.user-page) #toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#111827; color:#e5e7eb; border:1px solid #243244; padding:.8rem 1rem; border-radius:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.25); display:none; z-index:10000;
    }

    /* Modal */
    :where(.user-page) .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:10000;
    }
    :where(.user-page) .modal{
      position:fixed; inset:0; display:none; z-index:10001; align-items:center; justify-content:center; padding:1rem;
    }
    :where(.user-page) .modal .modal-card{
      background:#fff; color:#111; border-radius:14px; width:min(520px, 96vw);
      box-shadow:0 20px 60px rgba(0,0,0,.25); padding:1rem; border:1px solid #e5e7eb;
    }
    :where(.user-page) .modal h4{ margin:.25rem 0 .5rem; font-size:1.05rem; color:#111 }
    :where(.user-page) .modal p{ margin:.35rem 0 .9rem; color:#374151 }
    :where(.user-page) .modal .modal-actions{ display:flex; gap:.6rem; justify-content:flex-end }
    :where(.user-page) .modal .btn{ min-width:120px }
  </style>
</head>
<body>
  <!-- Mobile Menu Button -->
  <button class="menu-toggle" id="menuToggle"><i class="bi bi-list"></i></button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="profile">
      <img src="assets/avatar-default.png" alt="Profilbild" id="profileImg" />
      <h2 id="userName">Benutzer</h2>
      <p>Teilnehmer</p>
    </div>
    <nav class="menu">
      <button data-page="persoenlich"><i class="bi bi-person"></i> Persönliche Daten</button>
      <button data-page="zugang"><i class="bi bi-key"></i> Zugangsvoraussetzungen</button>
      <button data-page="dashboard"><i class="bi bi-speedometer2"></i> Dashboard</button>
      <button data-page="module"><i class="bi bi-journal"></i> Lernmodule</button>
      <button data-page="materialien"><i class="bi bi-folder2"></i> Lernmaterialien</button>
      <button class="active" data-page="benutzer"><i class="bi bi-people"></i> Benutzerverwaltung</button>
    </nav>
    <button class="logout" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Logout</button>
    <div class="version">Version 1.0.0</div>
  </aside>

  <!-- Content -->
  <main class="content" id="content">
    <!-- Benutzerverwaltung (gekapselt) -->
    <div class="user-page">
      <h2 class="page-title">Benutzerverwaltung</h2>

      <div class="settings-grid">
        <!-- Liste -->
        <div class="card">
          <h3><i class="bi bi-people"></i> Benutzerübersicht</h3>
          <table class="user-table" aria-label="Liste der Benutzer">
            <thead>
              <tr>
                <th>Anzeigename</th>
                <th>E-Mail-Adresse</th>
                <th>Rollen</th>
                <th style="width:44px;"></th>
              </tr>
            </thead>
            <tbody id="userList"></tbody>
          </table>
          <div id="userMsg" class="form-msg"></div>
        </div>

        <!-- Neuer Nutzer -->
        <div>
          <div class="card">
            <h3><i class="bi bi-person-plus"></i> Neuen Nutzer anlegen</h3>
            <form id="createUserForm" novalidate>
              <div class="form-group floating">
                <input type="email" id="newEmail" placeholder=" " required inputmode="email" autocomplete="email" />
                <label for="newEmail">E-Mail</label>
              </div>
              <div class="form-group floating">
                <input type="password" id="newPassword" placeholder=" " required autocomplete="new-password" minlength="6" />
                <label for="newPassword">Passwort</label>
              </div>
              <div class="form-group floating">
                <input type="text" id="newName" placeholder=" " autocomplete="name" />
                <label for="newName">Anzeigename (optional)</label>
              </div>
              <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Benutzer erstellen</button>
              <div id="createUserMsg" class="form-msg"></div>
            </form>
          </div>
        </div>
      </div>

      <!-- Editor (separat) -->
      <div id="editPanelOuter" class="card" style="display:none;">
        <div id="editPanel"></div>
      </div>

      <!-- Toast -->
      <div id="toast" role="status" aria-live="polite"></div>

      <!-- Modal + Backdrop -->
      <div id="modalBackdrop" class="modal-backdrop"></div>
      <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-card">
          <h4 id="modalTitle">Bestätigen</h4>
          <p id="modalMessage">Bist du sicher?</p>
          <div class="modal-actions">
            <button id="modalCancel" class="btn btn-secondary"><i class="bi bi-x-lg"></i> Abbrechen</button>
            <button id="modalOk" class="btn btn-danger"><i class="bi bi-trash"></i> Löschen</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- JS (ohne Firebase-Abhängigkeit) -->
  <script type="module">
    // Shell: Mobile Sidebar Toggle (standalone)
    const menuToggle = document.getElementById("menuToggle");
    const sidebar = document.getElementById("sidebar");
    if (menuToggle) {
      menuToggle.addEventListener("click", () => {
        sidebar.classList.toggle("active");
      });
    }

    // ---------------- Benutzerverwaltung ----------------
    const API_BASE = "https://us-central1-iuk-app.cloudfunctions.net";

    const userList = document.getElementById("userList");
    const userMsg  = document.getElementById("userMsg");
    const editPanelOuter = document.getElementById("editPanelOuter");
    const editPanel = document.getElementById("editPanel");
    const toastEl = document.getElementById("toast");

    // Modal
    const modal      = document.getElementById("modal");
    const backdrop   = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalMsg   = document.getElementById("modalMessage");
    const modalOk    = document.getElementById("modalOk");
    const modalCancel= document.getElementById("modalCancel");

    const ROLE_DEF = [
      { key:"admin",         label:"Admin",         cls:"role-admin" },
      { key:"gruppenleiter", label:"Gruppenleiter", cls:"role-gl" },
      { key:"helfer",        label:"Helfer",        cls:"role-hf" },
      { key:"anwärter",      label:"Anwärter",      cls:"role-an" },
    ];

    const showToast = (msg) => {
      toastEl.textContent = msg; toastEl.style.display = "block";
      clearTimeout(showToast._t); showToast._t = setTimeout(()=> toastEl.style.display = "none", 2600);
    };

    function confirmDialog({ title="Bestätigen", message="Bist du sicher?", okText="OK", cancelText="Abbrechen" } = {}){
      modalTitle.textContent = title;
      modalMsg.textContent = message;
      modalOk.innerHTML = `<i class="bi bi-check2"></i> ${okText}`;
      modalCancel.innerHTML = `<i class="bi bi-x-lg"></i> ${cancelText}`;

      return new Promise(resolve => {
        const close = (val) => {
          modal.style.display = "none";
          backdrop.style.display = "none";
          document.removeEventListener("keydown", onKey);
          resolve(val);
        };
        const onKey = (e) => { if (e.key === "Escape") close(false); };

        backdrop.style.display = "block";
        modal.style.display = "flex";
        document.addEventListener("keydown", onKey);

        modalOk.onclick = () => close(true);
        modalCancel.onclick = () => close(false);
        backdrop.onclick = () => close(false);
      });
    }

    function extractRoles(u){
      let roles = Array.isArray(u.roles) ? u.roles : [];
      if (!roles.length){
        ROLE_DEF.forEach(r => { if (u[r.key]) roles.push(r.key); });
        if (u.admin && !roles.includes("admin")) roles.push("admin");
      }
      const allowed = new Set(ROLE_DEF.map(r=>r.key));
      return Array.from(new Set(roles.filter(r=>allowed.has(r))));
    }

    function rolesToBadges(roles){
      if (!roles?.length) return '<span style="color:#9ca3af">–</span>';
      return '<div class="role-badges">' + roles.map(r=>{
        const def = ROLE_DEF.find(d=>d.key===r);
        return `<span class="role-badge ${def?.cls||""}">${def?.label||r}</span>`;
      }).join("") + '</div>';
    }

    function buildKebab(cell, onEdit, onDelete, user){
      cell.classList.add("actions-cell");
      const btn = document.createElement("button");
      btn.className = "kebab-btn"; btn.setAttribute("aria-label","Aktionen");
      btn.innerHTML = '<i class="bi bi-three-dots-vertical"></i>';

      const menu = document.createElement("div");
      menu.className = "kebab-menu";
      menu.innerHTML = `
        <button class="act-edit"><i class="bi bi-pencil"></i><span>Bearbeiten</span></button>
        <button class="act-del"  style="color:#b91c1c;"><i class="bi bi-trash"></i><span>Nutzer löschen</span></button>
      `;

      const openMenu = (e) => {
        e?.stopPropagation?.();
        const isOpen = menu.style.display === "block";
        document.querySelectorAll(".user-page .kebab-menu").forEach(m=>m.style.display="none");
        menu.style.display = isOpen ? "none" : "block";
      };
      btn.addEventListener("click", openMenu);
      document.addEventListener("click", () => { menu.style.display = "none"; });

      menu.querySelector(".act-edit").addEventListener("click", ()=>{ menu.style.display="none"; onEdit(user); });
      menu.querySelector(".act-del").addEventListener("click", ()=>{ menu.style.display="none"; onDelete(user); });

      cell.appendChild(btn); cell.appendChild(menu);
    }

    function updateNavigationDisplayName(newName){
      const ids = ["navUserName","sidebarUserName"];
      ids.forEach(id => { const el = document.getElementById(id); if (el) el.textContent = newName || "Ohne Namen"; });
      document.querySelectorAll("[data-user-name]").forEach(el => el.textContent = newName || "Ohne Namen");
    }

    function openEditor(user){
      const initial = {
        name: user.displayName || "",
        roles: extractRoles(user)
      };

      editPanelOuter.style.display = "block";
      editPanel.innerHTML = `
        <h3 style="margin-top:0;">Nutzer bearbeiten</h3>

        <div class="editor-row">
          <div class="form-group floating">
            <input type="text" id="edName" placeholder=" " value="${initial.name}">
            <label for="edName">Anzeigename</label>
          </div>
          <div class="form-group floating">
            <input type="email" id="edEmail" placeholder=" " value="${user.email || ""}" readonly>
            <label for="edEmail">E-Mail-Adresse</label>
          </div>
          <div class="form-group floating">
            <input type="text" id="edUID" placeholder=" " value="${user.uid}" readonly>
            <label for="edUID">UID</label>
          </div>
        </div>

        <div id="rolesSection">
          <h4>Rollen</h4>
          <div class="roles-grid">
            ${ROLE_DEF.map(r => `
              <label class="role-check">
                <input type="checkbox" value="${r.key}" ${initial.roles.includes(r.key) ? "checked":""} />
                <span class="role-badge ${r.cls}">${r.label}</span>
              </label>
            `).join("")}
          </div>
        </div>

        <div class="editor-actions">
          <button class="btn btn-secondary" id="edCancel"><i class="bi bi-x-lg"></i> Abbrechen</button>
          <button class="btn btn-primary"  id="edSave"><i class="bi bi-save"></i> Speichern</button>
        </div>
      `;

      document.getElementById("edCancel").onclick = () => {
        showToast("Änderungen verworfen");
        editPanelOuter.style.display = "none";
        editPanel.innerHTML = "";
      };

      document.getElementById("edSave").onclick = async () => {
        const newName = document.getElementById("edName").value.trim();
        const selected = Array.from(editPanel.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);

        try{
          const res = await fetch(API_BASE + "/updateUser", {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ uid: user.uid, displayName: newName, roles: selected })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Unbekannter Fehler");

          showToast("Gespeichert");
          updateNavigationDisplayName(newName);
          await loadUsers();

          editPanelOuter.style.display = "none";
          editPanel.innerHTML = "";
        }catch(err){
          showToast("Fehler: " + err.message);
        }
      };
    }

    async function deleteUserFlow(user){
      const title = "Nutzer löschen?";
      const who = user.displayName || user.email || user.uid;
      const message = `Soll der Nutzer wirklich gelöscht werden?\n\n${who}`;
      const ok = await confirmDialog({ title, message, okText:"Löschen", cancelText:"Abbrechen" });
      if (!ok) return;

      try{
        const res = await fetch(API_BASE + "/deleteUser", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ uid: user.uid })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Unbekannter Fehler");
        showToast("Nutzer gelöscht");
        await loadUsers();
        editPanelOuter.style.display = "none"; editPanel.innerHTML = "";
      }catch(err){
        showToast("Fehler: " + err.message);
      }
    }

    function renderUsers(users){
      userList.innerHTML = "";
      users.forEach(u=>{
        const tr = document.createElement("tr");
        const name = u.displayName || "Ohne Namen";
        const mail = u.email || "–";
        const roles = extractRoles(u);

        tr.innerHTML = `
          <td class="nowrap td-name" data-label="Anzeigename" title="${name}"><b>${name}</b></td>
          <td class="nowrap" data-label="E-Mail-Adresse" title="${mail}"><span class="email-val">${mail}</span></td>
          <td class="td-roles" data-label="Rollen">${rolesToBadges(roles)}</td>
          <td class="actions-cell" data-label=""></td>
        `;
        const actionsCell = tr.querySelector(".actions-cell");
        buildKebab(actionsCell, openEditor, deleteUserFlow, { uid: u.uid, displayName:name, email:mail, roles });

        userList.appendChild(tr);
      });
    }

    async function loadUsers(){
      userMsg.style.color = "orange";
      userMsg.textContent = "⏳ Lade Nutzer...";
      try{
        const res = await fetch(API_BASE + "/listUsers");
        const data = await res.json();
        renderUsers(data.users || []);
        userMsg.textContent = "";
      }catch(err){
        userMsg.style.color = "red";
        userMsg.textContent = "❌ Fehler beim Laden der Nutzer: " + err.message;
      }
    }

    // Init
    loadUsers();

    // Neuer Nutzer
    const form = document.getElementById("createUserForm");
    const msg  = document.getElementById("createUserMsg");
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = document.getElementById("newEmail").value.trim();
      const pw    = document.getElementById("newPassword").value;
      const name  = document.getElementById("newName").value.trim();

      if (!email || !pw){
        msg.style.color = "red"; msg.textContent = "❌ E-Mail und Passwort sind erforderlich.";
        return;
      }
      msg.textContent = ""; // Bestätigung via Toast

      try{
        const res = await fetch(API_BASE + "/createUser", {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ email, password: pw, displayName: name })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Unbekannter Fehler");

        showToast("Benutzer erstellt");
        form.reset();
        await loadUsers();
      }catch(err){
        msg.style.color = "red"; msg.textContent = "❌ Fehler: " + err.message;
      }
    });
  </script>
</body>
</html>
