<h2 class="page-title">Benutzerverwaltung</h2>

<div class="settings-grid">
  <!-- Linke Spalte: Nutzerliste -->
  <div class="card">
    <h3><i class="bi bi-people"></i> Benutzer√ºbersicht</h3>
    <table class="user-table">
      <thead>
        <tr>
          <th>Name / E-Mail</th>
          <th>UID</th>
          <th>Admin</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody id="userList">
        <!-- Nutzer werden hier dynamisch eingef√ºgt -->
      </tbody>
    </table>
    <div id="userMsg" class="form-msg"></div>
  </div>

  <!-- Rechte Spalte: Nutzer anlegen -->
  <div>
    <div class="card">
      <h3><i class="bi bi-person-plus"></i> Neuen Nutzer anlegen</h3>
      <form id="createUserForm">
        <div class="form-group floating">
          <input type="email" id="newEmail" placeholder=" " required>
          <label for="newEmail">E-Mail</label>
        </div>
        <div class="form-group floating">
          <input type="password" id="newPassword" placeholder=" " required>
          <label for="newPassword">Passwort</label>
        </div>
        <div class="form-group floating">
          <input type="text" id="newName" placeholder=" ">
          <label for="newName">Anzeigename (optional)</label>
        </div>
        <button type="submit" class="btn-primary">
          <i class="bi bi-save"></i> Benutzer erstellen
        </button>
        <div id="createUserMsg" class="form-msg"></div>
      </form>
    </div>
  </div>
</div>

<style>
  :root {
    --softrot: rgb(228,100,80);
    --dunkelblau: rgb(0,45,85);
    --hellgrau: rgb(239,238,234);
    --blassblau: rgb(230,240,250);
  }

  .page-title {
    color: var(--softrot);
    margin-bottom: 1rem;
  }

  .settings-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
  }
  @media(max-width: 768px){
    .settings-grid { grid-template-columns: 1fr; }
  }

  .card {
    background: var(--card-bg, #fff);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }

  .card h3 {
    color: var(--dunkelblau);
    margin-top: 0;
    margin-bottom: 1rem;
  }

  .user-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
  }
  .user-table th, .user-table td {
    border-bottom: 1px solid #ddd;
    padding: 0.6rem;
    text-align: left;
    vertical-align: top;
  }
  .user-table th {
    background: var(--blassblau);
  }

  .btn-primary, .btn-secondary, .btn-danger {
    padding:0.4rem 0.8rem;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-size: 0.85rem;
  }
  .btn-primary { background: var(--dunkelblau); color: #fff; }
  .btn-secondary { background:#eee; }
  .btn-danger { background:#c62828; color: #fff; }

  .form-msg {
    margin-top:0.5rem;
    font-weight:bold;
  }

  /* Floating Label */
  .form-group.floating {
    position: relative;
    margin-bottom: 1.5rem;
  }
  .form-group.floating input {
    width: 100%;
    padding: 1rem 0.75rem 0.25rem 0.75rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    background: #fff;
    font-size: 1rem;
    box-sizing: border-box;
    transition: background 0.2s, border-color 0.2s;
  }
  .form-group.floating label {
    position: absolute;
    top: 50%;
    left: 0.75rem;
    transform: translateY(-50%);
    color: #777;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    pointer-events: none;
    background: var(--card-bg, #fff);
    padding: 0 0.25rem;
  }
  .form-group.floating input:focus + label,
  .form-group.floating input:not(:placeholder-shown) + label {
    top: 0;
    left: 0.6rem;
    font-size: 0.8rem;
    color: var(--dunkelblau);
  }

  /* Editor-Zeile */
  .user-editor {
    padding: 0.5rem 0;
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  .user-editor label {
    font-size: 0.9rem;
  }
  .user-editor input {
    padding: 0.3rem 0.5rem;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  /* Darkmode */
  body.dark .card {
    background: #1e1e1e;
    color: #f5f5f5;
  }
  body.dark .user-table th {
    background: #333;
  }
  body.dark .user-table td {
    border-bottom: 1px solid #555;
  }
  body.dark .form-group.floating label {
    background: #1e1e1e;
  }
</style>

<script type="module">
  console.log("‚úÖ benutzer.html geladen");

  import { auth, functions } from "../js/firebase.js";
  import { httpsCallable } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-functions.js";

  const userList = document.getElementById("userList");
  const userMsg = document.getElementById("userMsg");

  // Nutzer rendern
  function renderUsers(users){
    userList.innerHTML = "";
    users.forEach(u => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.displayName || "-"}<br><small>${u.email}</small></td>
        <td>${u.uid}</td>
        <td>${u.admin ? "‚úÖ" : "‚ùå"}</td>
        <td>
          <button class="btn-secondary toggle-admin">Admin ${u.admin ? "entfernen" : "setzen"}</button>
          <button class="btn-secondary edit-user">Bearbeiten</button>
          <button class="btn-danger delete-user">L√∂schen</button>
        </td>`;

      // Editierzeile
      const editorRow = document.createElement("tr");
      editorRow.style.display = "none";
      editorRow.innerHTML = `
        <td colspan="4">
          <div class="user-editor">
            <label>Name: <input type="text" value="${u.displayName || ""}" class="edit-name"></label>
            <button class="btn-primary save-user">Speichern</button>
          </div>
        </td>`;

      // Admin umschalten
      tr.querySelector(".toggle-admin").addEventListener("click", async () => {
        try {
          const fn = httpsCallable(functions, "setUserAdmin");
          await fn({ uid: u.uid, makeAdmin: !u.admin });
          userMsg.style.color = "green";
          userMsg.textContent = "‚úÖ Adminrechte ge√§ndert!";
          loadUsers();
        } catch (err) {
          userMsg.style.color = "red";
          userMsg.textContent = "‚ùå Fehler: " + err.message;
        }
      });

      // Bearbeiten √∂ffnen
      tr.querySelector(".edit-user").addEventListener("click", () => {
        editorRow.style.display = editorRow.style.display === "none" ? "table-row" : "none";
      });

      // Speichern
      editorRow.querySelector(".save-user").addEventListener("click", async () => {
        const newName = editorRow.querySelector(".edit-name").value;
        try {
          const fn = httpsCallable(functions, "updateUser");
          await fn({ uid: u.uid, displayName: newName });
          userMsg.style.color = "green";
          userMsg.textContent = "‚úÖ Benutzer aktualisiert!";
          loadUsers();
        } catch (err) {
          userMsg.style.color = "red";
          userMsg.textContent = "‚ùå Fehler: " + err.message;
        }
      });

      // User l√∂schen
      tr.querySelector(".delete-user").addEventListener("click", async () => {
        if (!confirm("Soll dieser Nutzer wirklich gel√∂scht werden?")) return;
        try {
          const fn = httpsCallable(functions, "deleteUser");
          await fn({ uid: u.uid });
          userMsg.style.color = "green";
          userMsg.textContent = "üóëÔ∏è Nutzer gel√∂scht!";
          loadUsers();
        } catch (err) {
          userMsg.style.color = "red";
          userMsg.textContent = "‚ùå Fehler: " + err.message;
        }
      });

      userList.appendChild(tr);
      userList.appendChild(editorRow);
    });
  }

  // Nutzer laden
  async function loadUsers(){
    try {
      const fn = httpsCallable(functions, "listUsers");
      const res = await fn();
      renderUsers(res.data.users);
    } catch (err) {
      userMsg.style.color = "red";
      userMsg.textContent = "‚ùå Fehler beim Laden der Nutzer: " + err.message;
      console.error("‚ùå Fehler beim Laden der Nutzer:", err);
    }
  }

  // Initial laden
  loadUsers();

  // Neuen Nutzer anlegen
  const form = document.getElementById("createUserForm");
  const msg = document.getElementById("createUserMsg");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("newEmail").value;
    const pw = document.getElementById("newPassword").value;
    const name = document.getElementById("newName").value;

    msg.style.color = "orange";
    msg.textContent = "‚è≥ wird erstellt...";

    try {
      const fn = httpsCallable(functions, "createUser");
      const res = await fn({ email, password: pw, displayName: name });
      msg.style.color = "green";
      msg.textContent = "‚úÖ Benutzer angelegt mit UID " + res.data.uid;
      loadUsers();
      form.reset();
    } catch(err) {
      msg.style.color = "red";
      msg.textContent = "‚ùå Fehler: " + err.message;
    }
  });
</script>
