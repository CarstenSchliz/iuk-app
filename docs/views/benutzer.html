<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Benutzerverwaltung</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
  /* ================================ THEME: zentrale Farb-Variablen ================================ */
  :root {
    --softrot: rgb(228,100,80);
    --dunkelblau: rgb(0,45,85);
    --hellblau: rgb(100,160,220);

    --bg: #f3f4f6;
    --text: #1f2937;
    --heading: #002d55;
    --link: #e06862;

    --card-bg: #ffffff;
    --card-border: #e5e7eb;

    --input-bg: #ffffff;
    --input-fg: #111827;
    --input-border: #d1d5db;
    --input-readonly-bg: #f9fafb;
    --input-readonly-fg: #555;

    --button-secondary-bg: #eef2f7;
    --button-secondary-fg: #111;

    --modal-bg: #ffffff;
    --modal-heading: #002d55;

    --blassblau: rgb(230,240,250);

    --toggle-track: #0f2030;
    --toggle-border: #e5e7eb;
    --toggle-star: #ffd84d;
    --toggle-knob: #ffffff;
  }

  body.dark {
    --bg: #000000;
    --text: #f3f4f6;
    --heading: #f3f4f6;
    --link: #4da6ff;

    --card-bg: #151515;
    --card-border: #2c2c2c;

    --input-bg: #222;
    --input-fg: #f3f4f6;
    --input-border: #3a3a3a;
    --input-readonly-bg: #2a2a2a;
    --input-readonly-fg: #bdbdbd;

    --button-secondary-bg: #2b2b2b;
    --button-secondary-fg: #e8e8e8;

    --modal-bg: #1e1e1e;
    --modal-heading: #f3f4f6;

    --toggle-track: #061018;
    --toggle-border: #2a2f35;
    --toggle-star: #ffd84d;
    --toggle-knob: #e9eef7;
  }

  html, body {
    margin:0; padding:0; height:100%;
    background: var(--bg) !important;
    overflow-x: hidden;
  }
  body {
    font-family: "Helvetica Neue", "Open Sans", Arial, sans-serif;
    color: var(--text);
    transition: background .2s ease, color .2s ease;
  }

  .page-title { color: var(--softrot); margin: 0 0 1rem; padding: 1rem; }

  .settings-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
    padding: 1rem;
  }
  @media (max-width: 768px) {
    .settings-grid {
      grid-template-columns: 1fr;
      justify-items: stretch;
      max-width: 560px;     /* Kartenbreite limitieren */
      margin: 0 auto;       /* mittig */
    }
    .card {
      width: 100%;
      max-width: 560px;
      margin: 0 0 1.5rem;
    }
  }

  .card {
    background: var(--card-bg);
    color: var(--text);
    border: 1px solid var(--card-border);
    padding: 1.5rem;
    border-radius: 14px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.28);
    margin-bottom: 1.5rem;
    transition: background .2s ease, color .2s ease, border-color .2s ease, box-shadow .2s ease;
    box-sizing: border-box;
    width: 100%;
  }
  body.dark .card { box-shadow: 0 10px 24px rgba(0,0,0,0.45); }
  .card h3 {
    color: var(--hellblau);
    margin: 0 0 1rem;
    font-size: 1.1rem;
    display: flex; align-items: center; gap: .5rem;
  }

  .form-group.floating { position: relative; margin-bottom: 1.2rem; }
  .form-group.floating input,
  .form-group.floating textarea {
    width: 100%;
    padding: 1rem 2.6rem .3rem .75rem;
    border: 1px solid var(--input-border);
    border-radius: 10px;
    background: var(--input-bg);
    color: var(--input-fg);
    font-size: 1rem;
    transition: border-color .15s ease, background .15s ease, color .15s ease;
    min-height: 44px;
    box-sizing: border-box;
    font-family: "Helvetica Neue", "Open Sans", Arial, sans-serif;
  }
  .form-group.floating label {
    position: absolute;
    top: 50%; left: .75rem; transform: translateY(-50%);
    color: #b0b6bf; font-size: .95rem; transition: all .15s;
    pointer-events: none; background: var(--card-bg); padding: 0 .25rem;
  }
  .form-group.floating input:focus + label,
  .form-group.floating input:not(:placeholder-shown) + label,
  .form-group.floating textarea:focus + label,
  .form-group.floating textarea:not(:placeholder-shown) + label {
    top: .1rem; left: .6rem; font-size: .78rem; color: var(--heading);
  }

  .form-group.floating input[readonly],
  .form-group.floating textarea[readonly] {
    background: var(--input-readonly-bg) !important;
    color: var(--input-readonly-fg);
    cursor: not-allowed;
  }

  body:not(.dark) .form-group.floating input:not(:placeholder-shown):not([readonly]),
  body:not(.dark) .form-group.floating textarea:not(:placeholder-shown):not([readonly]) {
    background: var(--blassblau);
    border-color: var(--dunkelblau);
  }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  @media (max-width:768px) { .form-row { grid-template-columns: 1fr; } }

  /* Rollen + UID */
  .form-group.floating textarea#roles,
  .form-group.floating textarea#uid {
    resize: none;
    height: 44px;
    line-height: normal;
    padding-top: 1rem;
    padding-bottom: .3rem;
    font-family: "Helvetica Neue", "Open Sans", Arial, sans-serif;
    font-size: 1rem;
  }

  .form-group.floating textarea {
    resize: none;
    line-height: 1.4;
    white-space: normal;
    overflow: auto;
  }

  .form-actions { display:flex; gap:1rem; margin-top:1rem; }
  .btn {
    padding:.6rem 1rem; border:none; border-radius:10px; cursor:pointer;
    font-size:.95rem; min-height:44px; min-width:140px;
    display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
    transition: filter .15s ease, background .2s ease, color .2s ease;
  }
  .btn-primary { background: var(--dunkelblau); color: #fff; }
  .btn-primary:hover { filter: brightness(1.03); }
  .btn-secondary { background: var(--button-secondary-bg); color: var(--button-secondary-fg); }
  .btn-secondary:hover { filter: none; background: var(--button-secondary-bg); color: var(--button-secondary-fg); }
  .btn-accent { background: var(--dunkelblau); color: #fff; }
  .form-msg { margin-top:.5rem; font-weight:600; }

  .list { list-style:none; margin:0; padding:0; }
  .list li { padding:.6rem 0; border-bottom:1px solid var(--card-border); cursor:pointer; display:flex; align-items:center; gap:.5rem; }

  .modal {
    position: fixed; inset: 0; display: none; justify-content: center; align-items: center;
    background: rgba(0,0,0,0.5); z-index: 1000; opacity: 0; transition: opacity .3s ease;
  }
  .modal.show { display:flex; opacity:1; }
  .modal-content {
    background: var(--modal-bg); color: var(--text);
    padding: 2rem; border-radius: 16px; box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    width: 92%; max-width: 520px; box-sizing: border-box; transform: scale(.97);
    transition: transform .25s ease, opacity .25s ease, background .2s ease, color .2s ease;
    opacity: 1;
  }
  .modal.show .modal-content { transform: scale(1); }
  .modal-content h2 {
    color: var(--modal-heading); font-size: 1.4rem; margin: .3rem 0 1.1rem; text-align: center;
  }
  .modal-actions { display:flex; gap:1rem; margin-top:1rem; }
  .modal-actions button {
    flex:1; padding:.7rem; border:none; border-radius:6px; font-size:.95rem; font-weight:bold; cursor:pointer; min-height:44px;
  }
  .modal-actions .primary { background: var(--dunkelblau); color: #fff; }
  .modal-actions .close { background: var(--button-secondary-bg); color: var(--button-secondary-fg); }

  #pass-rules { font-size:.85rem; text-align:left; margin: 6px 0 12px 2px; line-height: 1.35; display: none; }

  .pw-meter { height: 8px; border-radius: 999px; background: var(--card-border); margin: 6px 2px 6px; overflow: hidden; display: none; }
  .pw-meter-bar { height: 100%; width: 0%; border-radius: 999px; transition: width .2s ease, background .2s ease; }
  .pw-strength { display:none; margin: 0 2px 10px; font-size: .86rem; font-weight: 700; }

  .theme-switch {
    --w: 80px; --h: 40px;
    position: relative; width: var(--w); height: var(--h);
    border-radius: 999px; border: 2px solid var(--toggle-border);
    background: var(--toggle-track); cursor: pointer; user-select: none;
    transition: background .25s ease, border-color .25s ease, box-shadow .25s ease;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04); overflow: hidden; display: block;
  }
  .theme-switch .icon {
    position: absolute; top: 50%; transform: translateY(-50%);
    font-size: 18px; width: 22px; height: 22px; pointer-events: none; opacity: .9; z-index: 1;
  }
  .theme-switch .sun { left: 10px; color: #ffda65; }
  .theme-switch .moon { right: 10px; color: #ffd84d; }

  .theme-switch .thumb {
    position: absolute; top: 4px; left: 4px;
    width: calc(var(--h) - 8px); height: calc(var(--h) - 8px);
    border-radius: 50%; background: var(--toggle-knob);
    box-shadow: 0 2px 6px rgba(0,0,0,.25);
    transition: transform .35s cubic-bezier(.22,.61,.36,1), background .25s ease;
    z-index: 2;
  }
  body.dark .theme-switch .thumb { transform: translateX(calc(var(--w) - var(--h))); }

  .theme-switch::before, .theme-switch::after {
    content: "‚òÖ"; position: absolute; color: var(--toggle-star); font-size: 12px; opacity: .0; transform: translateY(-2px); transition: opacity .25s ease;
  }
  .theme-switch::before { right: 26px; top: 8px; }
  .theme-switch::after  { right: 14px; bottom: 8px; font-size: 10px; }
  body.dark .theme-switch::before, body.dark .theme-switch::after { opacity: 1; }

  @keyframes sunSpinOnce { from{transform: translateY(-50%) rotate(0);} to{transform: translateY(-50%) rotate(360deg);} }
  @keyframes moonPulse { 0%,100%{ filter:drop-shadow(0 0 0 rgba(255,216,77,0)); } 50%{ filter:drop-shadow(0 0 8px rgba(255,216,77,.9)); } }
  body:not(.dark) .theme-switch .sun.burst { animation: sunSpinOnce .6s ease; }
  body.dark .theme-switch .moon { animation: moonPulse 1.6s ease-in-out infinite; }

  .theme-switch .sun::after, .theme-switch .moon::after {
    content:""; position:absolute; inset:-6px; border-radius:50%;
    background: radial-gradient(circle, rgba(255,220,120,.6) 0%, rgba(255,220,120,0) 60%);
    opacity:0; transform: scale(.6); transition: opacity .25s ease, transform .25s ease; z-index: -1;
  }
  body:not(.dark) .theme-switch .sun.burst::after { opacity:1; transform: scale(1.1); }
  body.dark .theme-switch .moon.burst::after { opacity:1; transform: scale(1.1); }

  .input-with-eye { position: relative; }
  .toggle-eye {
    position: absolute; right: .5rem; top: 50%; transform: translateY(-50%);
    border: 0; background: transparent; cursor: pointer; padding: .25rem;
    line-height: 1; display: inline-flex; align-items: center; justify-content: center;
    border-radius: 8px; color: var(--input-fg);
  }
  .toggle-eye:focus { outline: 2px solid var(--input-border); }

  body.dark .menu button.active { background: #fff; color: #000; font-weight: bold; }
  body.dark .menu button.active::before { background: #fff; }
</style>

</head>
<body>
  <div class="user-page" style="display:none">
    <h2 class="page-title">Benutzerverwaltung</h2>

    <div class="settings-grid">
      <!-- Nutzerliste (links oben) -->
      <div class="card">
        <h3><i class="bi bi-people"></i> Benutzer√ºbersicht</h3>
        <div style="position:relative; margin:12px 0 14px;">
          <i class="bi bi-search" 
             style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#6b7280; font-size:1rem;"></i>
          <input type="text" id="searchInput" placeholder="Suchen..."
            style="padding:8px 32px 8px 32px; width:100%; border-radius:8px; border:1px solid #ccc;">
          <button id="clearSearch" type="button"
            style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; font-size:1.2rem; color:#6b7280; cursor:pointer; display:none;">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <table class="user-table" aria-label="Liste der Benutzer">
          <thead>
            <tr>
              <th>Anzeigename</th>
              <th>E-Mail-Adresse</th>
              <th>Rollen</th>
              <th style="width:44px;"></th>
            </tr>
          </thead>
          <tbody id="userList"></tbody>
        </table>
        <div id="userMsg" class="form-msg"></div>
      </div>

      <!-- √Ñnderung: Editor ins Grid (unten, volle Breite) -->
      <div id="editPanelOuter" class="card" style="display:none;">
        <div id="editPanel"></div>
      </div>

      <!-- Neuer Nutzer (rechts oben) -->
      <div>
        <div class="card">
          <h3><i class="bi bi-person-plus"></i> Neuen Nutzer anlegen</h3>
          <form id="createUserForm" novalidate>
            <div class="form-group floating">
              <input type="email" id="newEmail" placeholder=" " required inputmode="email" autocomplete="email" />
              <label for="newEmail">E-Mail</label>
            </div>
            <div class="form-group floating">
              <input type="password" id="newPassword" placeholder=" " required autocomplete="new-password" minlength="6" />
              <label for="newPassword">Passwort</label>
            </div>
            <div class="form-group floating">
              <input type="text" id="newName" placeholder=" " autocomplete="name" />
              <label for="newName">Anzeigename (optional)</label>
            </div>
            <button type="submit" class="btn btn-primary" id="createBtn"><i class="bi bi-save"></i> Benutzer erstellen</button>
            <div id="createUserMsg" class="form-msg"></div>
          </form>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" role="status" aria-live="polite"></div>

    <!-- Modal -->
    <div id="modalBackdrop" class="modal-backdrop"></div>
    <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-card">
        <h4 id="modalTitle">Best√§tigen</h4>
        <p id="modalMessage">Bist du sicher?</p>
        <div class="modal-actions">
          <button id="modalCancel" class="btn btn-secondary"><i class="bi bi-x-lg"></i> Abbrechen</button>
          <button id="modalOk" class="btn btn-danger"><i class="bi bi-trash"></i> L√∂schen</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    /***********************
     * Firebase Import aus deinem Projekt
     ***********************/
    import { auth, getUserRoles } from "./js/firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // ‚úÖ richtige Region f√ºr deine Cloud Functions
    const API_BASE = "https://europe-west3-iuk-app.cloudfunctions.net";

    // Helper: ID-Token an jeden Request anh√§ngen
    async function apiFetch(endpoint, options = {}) {
      const user = auth.currentUser;
      if (!user) throw new Error("Nicht eingeloggt");
      const token = await user.getIdToken();

      const headers = {
        ...(options.headers || {}),
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      };

      return fetch(API_BASE + endpoint, { ...options, headers });
    }

    /***********************
     * Seite nur f√ºr Admin / Gruppenleiter
     ***********************/
    const pageRoot = document.querySelector(".user-page");
    function showNoAccess() {
      document.body.innerHTML = `
        <div style="max-width:720px;margin:8vh auto;padding:2rem;border:1px solid #e5e7eb;border-radius:14px;background:#fff;box-shadow:0 12px 30px rgba(0,0,0,.08);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;">
          <h2 style="margin-top:0;color:#b91c1c">Keine Berechtigung</h2>
          <p>Diese Seite ist nur f√ºr <b>Admins</b> oder <b>Gruppenleiter</b> sichtbar.</p>
          <button onclick="location.href='app.html'" style="padding:.6rem .9rem;border:none;border-radius:10px;background:#002d55;color:#fff;cursor:pointer">Zur√ºck zum Dashboard</button>
        </div>`;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "index.html"; return; }
      try {
        const roles = await getUserRoles(user.uid);
        if (roles.includes("admin") || roles.includes("gruppenleiter")) {
          pageRoot.style.display = "block";
          await loadUsers();
        } else {
          showNoAccess();
        }
      } catch (e) {
        console.error(e);
        alert("Authentifizierungsfehler");
        location.href = "index.html";
      }
    });

    /***********************
     * Dein bestehender UI-Code (unver√§ndert im Layout) + Tokenized API
     ***********************/
    let allUsers = [];
    let editorDirty = false;

    // DOM
    const userList = document.getElementById("userList");
    const userMsg  = document.getElementById("userMsg");
    const editPanelOuter = document.getElementById("editPanelOuter");
    const editPanel = document.getElementById("editPanel");
    const toastEl = document.getElementById("toast");
    const searchInput = document.getElementById("searchInput");
    const clearSearch = document.getElementById("clearSearch");

    // Modal
    const modal      = document.getElementById("modal");
    const backdrop   = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalMsg   = document.getElementById("modalMessage");
    const modalOk    = document.getElementById("modalOk");
    const modalCancel= document.getElementById("modalCancel");

    const ROLE_DEF = [
      { key:"admin",         label:"Admin",         cls:"role-admin" },
      { key:"gruppenleiter", label:"Gruppenleiter", cls:"role-gl" },
      { key:"helfer",        label:"Helfer",        cls:"role-hf" },
      { key:"anw√§rter",      label:"Anw√§rter",      cls:"role-an" },
    ];

    // Toast
    const showToast = (msg) => {
      toastEl.textContent = msg; toastEl.style.display = "block";
      clearTimeout(showToast._t); showToast._t = setTimeout(()=> toastEl.style.display = "none", 2600);
    };

    // Regex-sicheres Highlighting
    const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    function highlight(text, query) {
      if (!query) return text;
      const safe = escapeRegExp(query);
      const regex = new RegExp(`(${safe})`, "gi");
      return text.replace(regex, '<mark>$1</mark>');
    }

    // Modal Confirm
    function confirmDialog({ title="Best√§tigen", message="Bist du sicher?", okText="OK", cancelText="Abbrechen" } = {}) {
      modalTitle.textContent = title;
      modalMsg.textContent = message;
      modalOk.innerHTML = `<i class="bi bi-check2"></i> ${okText}`;
      modalCancel.innerHTML = `<i class="bi bi-x-lg"></i> ${cancelText}`;
      return new Promise(resolve => {
        const close = (val) => {
          modal.style.display = "none"; backdrop.style.display = "none";
          document.removeEventListener("keydown", onKey); resolve(val);
        };
        const onKey = (e) => { if (e.key === "Escape") close(false); };
        backdrop.style.display = "block"; modal.style.display = "flex";
        document.addEventListener("keydown", onKey);
        modalOk.onclick = () => close(true); modalCancel.onclick = () => close(false);
        backdrop.onclick = () => close(false);
      });
    }

    // Rollen extrahieren
    function extractRoles(u){
      return Array.isArray(u.roles) ? u.roles : [];
    }

    function rolesToBadges(roles){
      if (!roles?.length) return '<span style="color:#9ca3af">‚Äì</span>';
      return '<div class="role-badges">' + roles.map(r=>{
        const def = ROLE_DEF.find(d=>d.key===r);
        return `<span class="role-badge ${def?.cls||""}">${def?.label||r}</span>`;
      }).join("") + '</div>';
    }

    function buildKebab(cell, user){
      cell.classList.add("actions-cell");
      cell.innerHTML = `
        <button class="kebab-btn" aria-label="Aktionen"><i class="bi bi-three-dots-vertical"></i></button>
        <div class="kebab-menu">
          <button class="act-edit"><i class="bi bi-pencil"></i><span>Bearbeiten</span></button>
          <button class="act-del"  style="color:#b91c1c;"><i class="bi bi-trash"></i><span>Nutzer l√∂schen</span></button>
        </div>`;
      cell.querySelector(".act-edit").onclick = ()=>openEditor(user);
      cell.querySelector(".act-del").onclick = ()=>deleteUserFlow(user);
    }

    // Globaler Kebab Listener
    document.addEventListener("click",(e)=>{
      document.querySelectorAll(".kebab-menu").forEach(m=>m.style.display="none");
      if(e.target.closest(".kebab-btn")){
        const menu=e.target.closest(".actions-cell").querySelector(".kebab-menu");
        menu.style.display="block"; e.stopPropagation();
      }
    });

    // Editor
    function openEditor(user){
      if(editorDirty && !confirm("Ungespeicherte √Ñnderungen verwerfen?")) return;
      const initial = { name: user.displayName || "", roles: extractRoles(user) };

      editPanelOuter.style.display = "block";
      editPanel.innerHTML = `
        <h3 style="margin-top:0;">Nutzer bearbeiten</h3>
        <div class="editor-row">
          <div class="form-group floating">
            <input type="text" id="edName" placeholder=" " value="${initial.name}">
            <label for="edName">Anzeigename</label>
          </div>
          <div class="form-group floating">
            <input type="email" id="edEmail" placeholder=" " value="${user.email || ""}" readonly>
            <label for="edEmail">E-Mail-Adresse</label>
          </div>
          <div class="form-group floating">
            <input type="text" id="edUID" placeholder=" " value="${user.uid}" readonly>
            <label for="edUID">UID</label>
          </div>
        </div>
        <div id="rolesSection">
          <h4>Rollen</h4>
          <div class="roles-grid">
            ${ROLE_DEF.map(r => `
              <label class="role-check">
                <input type="checkbox" value="${r.key}" ${initial.roles.includes(r.key) ? "checked":""} />
                <span class="role-badge ${r.cls}">${r.label}</span>
              </label>
            `).join("")}
          </div>
        </div>
        <div class="editor-actions">
          <button class="btn btn-secondary" id="edCancel"><i class="bi bi-x-lg"></i> Abbrechen</button>
          <button class="btn btn-primary"  id="edSave"><i class="bi bi-save"></i> Speichern</button>
        </div>
      `;

      editorDirty=false;
      editPanel.querySelectorAll("input").forEach(inp=>{
        inp.addEventListener("input",()=>editorDirty=true);
      });

      document.getElementById("edCancel").onclick = () => {
        showToast("√Ñnderungen verworfen");
        editPanelOuter.style.display = "none";
        editPanel.innerHTML = "";
      };

      document.getElementById("edSave").onclick = async () => {
        const btn=document.getElementById("edSave");
        btn.disabled=true; btn.textContent="‚è≥ Speichern...";
        const newName = document.getElementById("edName").value.trim();
        const selected = Array.from(editPanel.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);

        try{
          const res = await apiFetch("/updateUser", {
            method:"POST",
            body: JSON.stringify({ uid: user.uid, displayName: newName, roles: selected })
          });
          if (!res.ok) {
            let msg = `${res.status} ${res.statusText}`;
            try { const j = await res.json(); if (j?.error) msg += ` ‚Äì ${j.error}`; } catch {}
            throw new Error(msg);
          }
          showToast("Gespeichert");
          await loadUsers();

          editPanelOuter.style.display = "none";
          editPanel.innerHTML = "";
          editorDirty=false;
        }catch(err){
          showToast("Fehler: " + err.message);
        }finally{
          btn.disabled=false; btn.innerHTML='<i class="bi bi-save"></i> Speichern';
        }
      };
    }

    // L√∂schen
    async function deleteUserFlow(user){
      const title = "Nutzer l√∂schen?";
      const who = user.displayName || user.email || user.uid;
      const message = `Soll der Nutzer wirklich gel√∂scht werden?\n\n${who}`;
      const ok = await confirmDialog({ title, message, okText:"L√∂schen", cancelText:"Abbrechen" });
      if (!ok) return;

      try{
        const res = await apiFetch("/deleteUser", {
          method:"POST",
          body: JSON.stringify({ uid: user.uid })
        });
        if (!res.ok) {
          let msg = `${res.status} ${res.statusText}`;
          try { const j = await res.json(); if (j?.error) msg += ` ‚Äì ${j.error}`; } catch {}
          throw new Error(msg);
        }
        showToast("Nutzer gel√∂scht");
        await loadUsers();
        editPanelOuter.style.display = "none"; editPanel.innerHTML = "";
      }catch(err){
        showToast("Fehler: " + err.message);
      }
    }

    // Nutzerliste rendern
    function renderUsers(users){
      const q = searchInput.value.toLowerCase();
      const safeQ = escapeRegExp(q);
      userList.innerHTML = "";

      const filtered = users.filter(u => {
        const roles = extractRoles(u);
        const roleLabels = roles.map(r => {
          const def = ROLE_DEF.find(d => d.key === r);
          return def ? def.label.toLowerCase() : r.toLowerCase();
        });
        return (
          u.displayName?.toLowerCase().includes(q) ||
          u.email?.toLowerCase().includes(q) ||
          roles.some(r => r.toLowerCase().includes(q)) ||
          roleLabels.some(lbl => lbl.includes(q))
        );
      });

      if (filtered.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" style="text-align:center; padding:1rem; color:#6b7280;">
          Keine Treffer gefunden
        </td>`;
        userList.appendChild(tr);
        return;
      }

      filtered.forEach(u => {
        const tr = document.createElement("tr");
        const name = u.displayName || "Ohne Namen";
        const mail = u.email || "‚Äì";
        const roles = extractRoles(u);

        // Name
        const tdName = document.createElement("td");
        tdName.className = "nowrap td-name";
        tdName.setAttribute("data-label","Anzeigename");
        tdName.title = name;
        tdName.innerHTML = `<b>${highlight(name, q)}</b>`;
        tr.appendChild(tdName);

        // Mail
        const tdMail = document.createElement("td");
        tdMail.className = "nowrap";
        tdMail.setAttribute("data-label","E-Mail-Adresse");
        tdMail.title = mail;
        tdMail.innerHTML = `<span class="email-val">${highlight(mail, q)}</span>`;
        tr.appendChild(tdMail);

        // Rollen
        const tdRoles = document.createElement("td");
        tdRoles.className = "td-roles";
        tdRoles.setAttribute("data-label","Rollen");
        tdRoles.innerHTML = rolesToBadges(roles);
        if (q) {
          tdRoles.innerHTML = tdRoles.innerHTML.replace(
            new RegExp(safeQ,"gi"),
            match => `<mark>${match}</mark>`
          );
        }
        tr.appendChild(tdRoles);

        // Aktionen
        const tdActions = document.createElement("td");
        tdActions.className = "actions-cell";
        tdActions.setAttribute("data-label","");
        buildKebab(tdActions, { uid: u.uid, displayName: name, email: mail, roles });
        tr.appendChild(tdActions);

        userList.appendChild(tr);
      });
    }

    // Nutzer laden
    async function loadUsers(){
      userMsg.style.color = "orange"; userMsg.textContent = "‚è≥ Lade Nutzer...";
      try{
        const res = await apiFetch("/listUsers", { method:"GET" });
        if (!res.ok) {
          let msg = `${res.status} ${res.statusText}`;
          try { const j = await res.json(); if (j?.error) msg += ` ‚Äì ${j.error}`; } catch {}
          throw new Error(msg);
        }
        const data = await res.json();
        allUsers=(data.users||[]).sort((a,b)=>(a.displayName||a.email||"").localeCompare(b.displayName||b.email||"","de",{sensitivity:"base"}));
        renderUsers(allUsers);
        userMsg.textContent = "";
      }catch(err){
        userMsg.style.color = "red"; userMsg.textContent = "‚ùå Fehler beim Laden der Nutzer: " + err.message;
      }
    }

    // Neuer Nutzer
    const form = document.getElementById("createUserForm");
    const msg  = document.getElementById("createUserMsg");
    const createBtn = document.getElementById("createBtn");

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = document.getElementById("newEmail").value.trim();
      const pw    = document.getElementById("newPassword").value;
      const name  = document.getElementById("newName").value.trim();

      if (!email || !pw){
        msg.style.color = "red"; msg.textContent = "‚ùå E-Mail und Passwort sind erforderlich.";
        return;
      }
      msg.textContent = "";

      createBtn.disabled=true;
      createBtn.textContent="‚è≥ Erstelle...";

      try{
        const res = await apiFetch("/createUser", {
          method:"POST", headers:{}, // Headers setzt apiFetch
          body: JSON.stringify({ email, password: pw, displayName: name })
        });
        if (!res.ok) {
          let em = `${res.status} ${res.statusText}`;
          try { const j = await res.json(); if (j?.error) em += ` ‚Äì ${j.error}`; } catch {}
          throw new Error(em);
        }

        showToast("Benutzer erstellt");
        form.reset();
        await loadUsers();
      }catch(err){
        msg.style.color = "red"; msg.textContent = "‚ùå Fehler: " + err.message;
      }finally{
        createBtn.disabled=false;
        createBtn.innerHTML='<i class="bi bi-save"></i> Benutzer erstellen';
      }
    });

    // üîé Suchfeld-Events
    searchInput.addEventListener("input", () => {
      renderUsers(allUsers);
      clearSearch.style.display = searchInput.value ? "block" : "none";
    });
    clearSearch.addEventListener("click", () => {
      searchInput.value = "";
      clearSearch.style.display = "none";
      renderUsers(allUsers);
    });
  </script>
</body>
</html>
